from typing import Any, Dict, List, Optional, Tuple
import re
import asyncio
import json
import os

import httpx
from bs4 import BeautifulSoup
from starlette.concurrency import run_in_threadpool

from app.services.llm_client import LLMClient
try:
    from app.services.cache import cache_service
    CACHE_AVAILABLE = True
except ImportError:
    CACHE_AVAILABLE = False

# –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º: –µ—Å–ª–∏ TEST_MODE=true, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
# –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ LLM –º–æ–¥–µ–ª—è–º–∏
TEST_MODE = False  # os.getenv("TEST_MODE", "false").lower() == "true"  # –û–±—Ö–æ–¥—ã –æ—Ç–∫–ª—é—á–µ–Ω—ã, –Ω–æ –∫–æ–¥ –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è


class SiteAnalyzer:
    def __init__(self, llm_client: LLMClient) -> None:
        self.llm = llm_client

    async def fetch_html(self, url: str) -> str:
        timeout = httpx.Timeout(20.0)
        async with httpx.AsyncClient(timeout=timeout, follow_redirects=True) as client:
            resp = await client.get(url)
            resp.raise_for_status()
            return resp.text

    def html_to_text(self, html: str) -> Tuple[str, bool, Optional[str]]:
        soup = BeautifulSoup(html, "html.parser")
        for tag in soup(["script", "style", "noscript"]):
            tag.decompose()
        text = soup.get_text(separator="\n")
        lines = [line.strip() for line in text.splitlines()]
        chunks = [chunk for line in lines for chunk in line.split("  ")]
        cleaned = "\n".join(chunk for chunk in chunks if chunk)

        # –£–º–Ω–æ–µ —É—Å–µ—á–µ–Ω–∏–µ - –µ—Å–ª–∏ —Å–∞–π—Ç —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π, –±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–µ 40 000 —Å–∏–º–≤–æ–ª–æ–≤
        max_len = 40000
        truncated = False
        truncation_message: Optional[str] = None
        if len(cleaned) > max_len:
            cleaned = cleaned[:max_len] + "..."
            truncated = True
            truncation_message = "–û–±—ä–µ–º —Å–∞–π—Ç–∞ —Å–ª–∏—à–∫–æ–º –≤–µ–ª–∏–∫. –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤–∑—è—Ç–æ 40 000 —Å–∏–º–≤–æ–ª–æ–≤ —Ç–µ–∫—Å—Ç–∞."

        return cleaned, truncated, truncation_message

    async def get_steps(self, cleaned_text: str) -> List[str]:
        system_prompt = (
            "–¢—ã –∞–≤—Ç–æ—Ä –ø–æ—Å—Ç–æ–≤ –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö. –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –æ—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ù–∏–∫–∞–∫–æ–≥–æ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞. –í—Å–µ –∫–ª—é—á–∏, –∑–Ω–∞—á–µ–Ω–∏—è, –æ–ø–∏—Å–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ò–ì–ù–û–†–ò–†–£–ô —è–∑—ã–∫ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –æ—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º. –í–æ—Ç —Ç–µ–∫—Å—Ç —Å–∞–π—Ç–∞: "
            f"{cleaned_text}\n"
            "–≤–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ json-–æ–±—ä–µ–∫—Ç –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞. –ö–ª—é—á 'steps' ‚Äî –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫ –∏–∑ 5-6 —à–∞–≥–æ–≤ (–ø—Ä–æ–º–ø—Ç–æ–≤), –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞ –∏ –≤—ã—è–≤–ª–µ–Ω–∏—è –∏–¥–µ–π –¥–ª—è –ø–æ—Å—Ç–æ–≤ –≤ —Å–æ—Ü—Å–µ—Ç–∏. –í—Å–µ –æ—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ù–∏–∫–∞–∫–æ–≥–æ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.\n–≤–µ—Ä–Ω–∏ json"
        )
        # –ì–ò–ë–†–ò–î: –∏—Å–ø–æ–ª—å–∑—É–µ–º GPT-4o –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ JSON (—á–µ—Ä–µ–∑ use_alt=True)
        result = await run_in_threadpool(
            self.llm.chat_json,
            system_prompt=system_prompt,
            user_prompt="json",
            use_alt=True  # GPT-4o –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ JSON
        )
        # –û–∂–∏–¥–∞–µ–º, —á—Ç–æ –º–æ–¥–µ–ª—å –≤–µ—Ä–Ω—ë—Ç JSON —Å –∫–ª—é—á–æ–º steps –∏–ª–∏ list –≤ –∫–æ—Ä–Ω–µ
        steps: List[str] = []
        if isinstance(result, dict):
            if isinstance(result.get("steps"), list):
                steps = [str(x) for x in result["steps"]]
            elif isinstance(result.get("prompts"), list):
                steps = [str(x) for x in result["prompts"]]
        if not steps and isinstance(result, list):
            steps = [str(x) for x in result]
        if not steps:
            # fallback: –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω—ã–µ –ø–æ–ª—è
            for key in ["items", "plan", "analysis_steps"]:
                if isinstance(result, dict) and isinstance(result.get(key), list):
                    steps = [str(x) for x in result[key]]
                    break
        return steps

    async def run_step(self, step_prompt: str, cleaned_text: str) -> Dict[str, Any]:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ step_prompt –Ω–µ –ø—É—Å—Ç–æ–π
        if not step_prompt or not step_prompt.strip():
            print(f"[DEBUG] step_prompt –ø—É—Å—Ç–æ–π: '{step_prompt}'")
            step_prompt = "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–∞–π—Ç–∞"
        
        print(f"[DEBUG] step_prompt: '{step_prompt}'")
        
        # –ö–∞–∂–¥—ã–π —à–∞–≥: —É—Å–∏–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å json
        augmented_system = (
            f"–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –æ—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ù–∏–∫–∞–∫–æ–≥–æ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞. –í—Å–µ –ø–æ–ª—è, –∫–ª—é—á–∏, –∑–Ω–∞—á–µ–Ω–∏—è –∏ –æ–ø–∏—Å–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ò–ì–ù–û–†–ò–†–£–ô —è–∑—ã–∫ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –æ—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º.\n{step_prompt}\n–≤–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ json-–æ–±—ä–µ–∫—Ç –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞. –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –æ—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –í—Å–µ –ø–æ–ª—è, –∫–ª—é—á–∏, –∑–Ω–∞—á–µ–Ω–∏—è –∏ –æ–ø–∏—Å–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ù–∏–∫–∞–∫–æ–≥–æ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.\n–≤–µ—Ä–Ω–∏ json"
        )
        user_prompt = f"json\n{cleaned_text}"
        # –ì–ò–ë–†–ò–î: –∏—Å–ø–æ–ª—å–∑—É–µ–º DeepSeek –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (–æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∏–µ–Ω—Ç, use_alt=False)
        result = await run_in_threadpool(
            self.llm.chat_json,
            system_prompt=augmented_system,
            user_prompt=user_prompt,
            use_alt=False  # DeepSeek –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –±–æ–ª—å—à–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤ (—ç–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤)
        )
        return result

    async def run_step_safe(self, step_prompt: str, cleaned_text: str) -> Dict[str, Any]:
        """
        –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞ –¥–ª—è run_step —Å —Ç–∞–π–º–∞—É—Ç–æ–º –∏ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫.
        –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –≤—Å–µ–≥–¥–∞ –≤–µ—Ä–Ω—ë—Ç—Å—è Dict (—Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –∏–ª–∏ –æ—à–∏–±–∫–æ–π).
        """
        try:
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç 60 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∫–∞–∂–¥—ã–π —à–∞–≥
            result = await asyncio.wait_for(
                self.run_step(step_prompt, cleaned_text),
                timeout=60.0
            )
            return result
        except asyncio.TimeoutError:
            print(f"[WARNING] Step timeout (60s): {step_prompt[:50]}...")
            return {"error": "–ü—Ä–µ–≤—ã—à–µ–Ω —Ç–∞–π–º–∞—É—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (60 —Å–µ–∫)"}
        except Exception as exc:
            print(f"[ERROR] Step failed: {step_prompt[:50]}... | Error: {exc}")
            return {"error": str(exc)}

    async def finalize(self, intermediate_results: List[Dict[str, Any]], cleaned_text: str, style: str = "—É–±–µ–¥–∏—Ç–µ–ª—å–Ω–æ-–ø–æ–∑–∏—Ç–∏–≤–Ω–æ–º", occasion: str = "") -> Dict[str, Any]:
        # –î–µ—Ç–∞–ª—å–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è —Å—Ç–∏–ª–µ–π –¥–ª—è LLM
        style_guidelines = {
            "—É–±–µ–¥–∏—Ç–µ–ª—å–Ω–æ-–ø–æ–∑–∏—Ç–∏–≤–Ω–æ–º": "–ò—Å–ø–æ–ª—å–∑—É–π –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–µ —Å–ª–æ–≤–∞, –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏, –ø—Ä–∏–∑—ã–≤—ã –∫ –¥–µ–π—Å—Ç–≤–∏—é. –ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–π –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏. –¢–æ–Ω: –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π, –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π, —ç–Ω–µ—Ä–≥–∏—á–Ω—ã–π.",
            "–∏—Ä–æ–Ω–∏—á–Ω–æ–º": "–ò—Å–ø–æ–ª—å–∑—É–π –ª–µ–≥–∫—É—é –∏—Ä–æ–Ω–∏—é, –∏–≥—Ä—É —Å–ª–æ–≤, —é–º–æ—Ä. –ú–æ–∂–µ—à—å —Å–ª–µ–≥–∫–∞ –ø–æ–¥—à—É—á–∏–≤–∞—Ç—å –Ω–∞–¥ —Å—Ç–µ—Ä–µ–æ—Ç–∏–ø–∞–º–∏. –¢–æ–Ω: –æ—Å—Ç—Ä–æ—É–º–Ω—ã–π, —Å —é–º–æ—Ä–æ–º, –Ω–æ –Ω–µ –æ–±–∏–¥–Ω—ã–π.",
            "—Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–æ–º": "–ü–∏—à–∏ –∫–∞–∫ –≤ –¥—Ä—É–∂–µ—Å–∫–æ–π –±–µ—Å–µ–¥–µ, –∏—Å–ø–æ–ª—å–∑—É–π '—Ç—ã', —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ –æ–±–æ—Ä–æ—Ç—ã, —Å–ª–µ–Ω–≥. –ò–∑–±–µ–≥–∞–π –æ—Ñ–∏—Ü–∏–æ–∑–∞. –¢–æ–Ω: –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π, –±–ª–∏–∑–∫–∏–π.",
            "–ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω–æ–º": "–ó–∞–¥–∞–≤–∞–π –æ—Å—Ç—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã, –∏—Å–ø–æ–ª—å–∑—É–π —Å–º–µ–ª—ã–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, –±—Ä–æ—Å–∞–π –≤—ã–∑–æ–≤ —Å—Ç–µ—Ä–µ–æ—Ç–∏–ø–∞–º. –ü—Ä–∏–≤–ª–µ–∫–∞–π –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–µ–æ–±—ã—á–Ω—ã–º–∏ –∑–∞—è–≤–ª–µ–Ω–∏—è–º–∏. –¢–æ–Ω: –¥–µ—Ä–∑–∫–∏–π, –≤—ã–∑—ã–≤–∞—é—â–∏–π, —Ü–µ–ø–ª—è—é—â–∏–π.",
            "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–º": "–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π —Ñ–∞–∫—Ç—ã, —Ü–∏—Ñ—Ä—ã, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ú–∏–Ω–∏–º—É–º —ç–º–æ—Ü–∏–π, –º–∞–∫—Å–∏–º—É–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –¢–æ–Ω: –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π, –æ–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π.",
            "–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ-–¥–µ–ª–æ–≤–æ–º": "–ò—Å–ø–æ–ª—å–∑—É–π –¥–µ–ª–æ–≤—É—é –ª–µ–∫—Å–∏–∫—É, —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–ª–æ–∂–µ–Ω–∏–µ. –ò–∑–±–µ–≥–∞–π —Å–ª–µ–Ω–≥–∞ –∏ —ç–º–æ–¥–∑–∏. –¢–æ–Ω: —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π, –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π.",
            "—Å—Ç–æ—Ä–∏—Ç–µ–ª–ª–∏–Ω–≥–∞": "–†–∞—Å—Å–∫–∞–∑—ã–≤–∞–π –∏—Å—Ç–æ—Ä–∏—é —Å –∑–∞–≤—è–∑–∫–æ–π, —Ä–∞–∑–≤–∏—Ç–∏–µ–º –∏ –∫—É–ª—å–º–∏–Ω–∞—Ü–∏–µ–π. –ò—Å–ø–æ–ª—å–∑—É–π –æ–±—Ä–∞–∑—ã, –º–µ—Ç–∞—Ñ–æ—Ä—ã, —Å–æ–∑–¥–∞–≤–∞–π –∞—Ç–º–æ—Å—Ñ–µ—Ä—É. –¢–æ–Ω: –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π, —É–≤–ª–µ–∫–∞—é—â–∏–π, –æ–±—Ä–∞–∑–Ω—ã–π.",
            "–ø—Ä–æ–¥–∞—é—â–µ–º": "–§–æ–∫—É—Å –Ω–∞ –≤—ã–≥–æ–¥–µ –∫–ª–∏–µ–Ω—Ç–∞, –ø—Ä–∏–∑—ã–≤—ã –∫ –¥–µ–π—Å—Ç–≤–∏—é (CTA), —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏. –ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–π —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –¢–æ–Ω: —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–π, –∞–∫—Ç–∏–≤–Ω—ã–π, —Å—Ç–∏–º—É–ª–∏—Ä—É—é—â–∏–π.",
            "–º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–º": "–ò—Å–ø–æ–ª—å–∑—É–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã —Ç–∞–º –≥–¥–µ —É–º–µ—Å—Ç–Ω–æ, —Å—Å—ã–ª–∞–π—Å—è –Ω–∞ –∑–¥–æ—Ä–æ–≤—å–µ –∏ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏–µ. –ë—É–¥—å —Ç–æ—á–Ω—ã–º –∏ –∫–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω—ã–º. –¢–æ–Ω: –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –∑–∞–±–æ—Ç–ª–∏–≤—ã–π, —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π."
        }
        
        style_instruction = style_guidelines.get(style, "–°–ª–µ–¥—É–π –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Å—Ç–∏–ª—é –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω–æ.")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –∏–Ω—Ñ–æ–ø–æ–≤–æ–¥—É, –µ—Å–ª–∏ –æ–Ω —É–∫–∞–∑–∞–Ω
        occasion_instruction = ""
        if occasion and occasion.strip():
            occasion_instruction = (
                f"\n\n–ò–ù–§–û–ü–û–í–û–î / –ö–û–ù–¢–ï–ö–°–¢ –ü–£–ë–õ–ò–ö–ê–¶–ò–ò: {occasion.strip()}\n"
                f"–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É—á—Ç–∏ —ç—Ç–æ—Ç –∏–Ω—Ñ–æ–ø–æ–≤–æ–¥ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Å—Ç–æ–≤! –ü–æ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–≤—è–∑–∞–Ω—ã —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –ø–æ–≤–æ–¥–æ–º –∏–ª–∏ —Å–æ–±—ã—Ç–∏–µ–º. "
                f"–ê–¥–∞–ø—Ç–∏—Ä—É–π —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ–¥ —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç, –¥–µ–ª–∞–π –∞–∫—Ü–µ–Ω—Ç—ã –Ω–∞ —Ç–æ–º, –∫–∞–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å —Å–∞–π—Ç–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –¥–∞–Ω–Ω—ã–º –ø–æ–≤–æ–¥–æ–º.\n"
            )
        
        system_prompt = (
            "–¢—ã —Ç–∞–ª–∞–Ω—Ç–ª–∏–≤—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä. –£ —Ç–µ–±—è –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Å–∞–π—Ç–∞: "
            f"{intermediate_results}. "
            f"–û–±—ä–µ–¥–∏–Ω–∏ –∏—Ö –∏ —Å–æ–∑–¥–∞–π —Ç—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–æ—Å—Ç–æ–≤ –¥–ª—è —Å–æ—Ü—Å–µ—Ç–∏ –≤ {style} —Å—Ç–∏–ª–µ. "
            f"{occasion_instruction}"
            f"\n\n–û–°–û–ë–ï–ù–ù–û–°–¢–ò {style.upper()} –°–¢–ò–õ–Ø: {style_instruction}\n\n"
            "–°–¢–†–û–ì–û —Å–ª–µ–¥—É–π —ç—Ç–æ–º—É —Å—Ç–∏–ª—é! –ö–∞–∂–¥—ã–π –ø–æ—Å—Ç –¥–æ–ª–∂–µ–Ω —è–≤–Ω–æ –æ—Ç—Ä–∞–∂–∞—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ —á–µ—Ä—Ç—ã –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—Ç–∏–ª—è. "
            "–≤–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ json-–æ–±—ä–µ–∫—Ç –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞. –°—Ç—Ä—É–∫—Ç—É—Ä–∞: {"
            "\"posts\": [string, string, string]} . "
            "–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ö–∞–∂–¥–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 400 –∏ –º–∞–∫—Å–∏–º—É–º 800 –∑–Ω–∞–∫–æ–≤ (–≤–∫–ª—é—á–∞—è –ø—Ä–æ–±–µ–ª—ã, —ç–º–æ–¥–∑–∏ –∏ –≤—Å–µ —Å–∏–º–≤–æ–ª—ã). "
            "–ù–µ –¥–µ–ª–∞–π –ø–æ—Å—Ç—ã –∫–æ—Ä–æ—á–µ 400 —Å–∏–º–≤–æ–ª–æ–≤! –ü–æ—Å—Ç—ã –∫–æ—Ä–æ—á–µ 400 —Å–∏–º–≤–æ–ª–æ–≤ –±—É–¥—É—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω—ã. "
            "–î–µ–ª–∞–π –ø–æ—Å—Ç—ã —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–º–∏, –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–º–∏. "
            "–ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏. "
            "–î–æ–±–∞–≤–ª—è–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –∏–∑ –∞–Ω–∞–ª–∏–∑–∞ —Å–∞–π—Ç–∞. "
            "–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ù–∏–∫–∞–∫–æ–≥–æ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.\njson"
        )
        # –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ù–ï –ø–µ—Ä–µ–¥–∞—ë–º cleaned_text - –≤—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —É–∂–µ –≤ intermediate_results!
        user_prompt = "json"
        # –ì–ò–ë–†–ò–î: –∏—Å–ø–æ–ª—å–∑—É–µ–º GPT-4o –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ JSON (—á–µ—Ä–µ–∑ use_alt=True)
        result = await run_in_threadpool(
            self.llm.chat_json,
            system_prompt=system_prompt,
            user_prompt=user_prompt,
            use_alt=True  # GPT-4o –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ JSON
        )
        return result

    async def analyze(
        self, 
        url: str, 
        style: str = "—É–±–µ–¥–∏—Ç–µ–ª—å–Ω–æ-–ø–æ–∑–∏—Ç–∏–≤–Ω–æ–º",
        occasion: str = "",
        use_cached: bool = False,
        cached_intermediate: Optional[List[Dict[str, Any]]] = None,
        email: Optional[str] = None  # Email –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫—ç—à–∞ –∫ —Å–µ–∞–Ω—Å—É
    ) -> Dict[str, Any]:
        # –¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú: –ó–∞—à—É–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–æ–≤ 14 –∏ 15 –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏
        if TEST_MODE:
            print("[TEST_MODE] –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥ (–±–ª–æ–∫ 14) –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é (–±–ª–æ–∫ 15), –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ")
            return self._get_mock_result(url, style, occasion)
        
        # –ö—ç—à –ø–æ–ª–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è - –∫–∞–∂–¥—ã–π —Å—Ç–∏–ª—å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ
        # –ö—ç—à –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–∞—Ä—Å–∏–Ω–≥–∞ (—Ç–µ–∫—Å—Ç —Å–∞–π—Ç–∞, —à–∞–≥–∏ –∞–Ω–∞–ª–∏–∑–∞)
        
        # –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –∏ –µ—Å—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        if use_cached and cached_intermediate:
            # –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—Å—ë - –ø–∞—Ä—Å–∏–Ω–≥, –∞–Ω–∞–ª–∏–∑, —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞!
            # cleaned_text –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω –≤ finalize(), –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É
            cleaned_text = ""
            truncated = False
            truncation_message = None
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            intermediate = cached_intermediate
            steps = [item.get("step", "") for item in intermediate]
            
            # –¢–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Å –Ω–æ–≤—ã–º —Å—Ç–∏–ª–µ–º –∏ –∏–Ω—Ñ–æ–ø–æ–≤–æ–¥–æ–º (cleaned_text –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è!)
            final = await self.finalize(intermediate, cleaned_text, style, occasion)
            
            result = {
                "url": url,
                "style": style,
                "occasion": occasion,
                "steps": steps,
                "intermediate_results": intermediate,
                "final": final,
                "truncated": truncated,
                "truncation_message": truncation_message,
                "cached": True  # –§–ª–∞–≥ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –∫—ç—à
            }
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫—ç—à (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
            if CACHE_AVAILABLE:
                await cache_service.set_analysis_result(url, style, occasion, result)
            return result
        
        # –û–±—ã—á–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å
        # –í–ê–ñ–ù–û: –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ (use_cached=False) –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        cleaned_text = None
        if use_cached and CACHE_AVAILABLE:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —è–≤–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
            cleaned_text = await cache_service.get_cleaned_text(url)
        
        if cleaned_text:
            truncated = False
            truncation_message = None
        else:
            # –ü–∞—Ä—Å–∏–º —Å–∞–π—Ç (–≤—Å–µ–≥–¥–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ –∏–ª–∏ –µ—Å–ª–∏ –∫—ç—à –ø—É—Å—Ç)
            html = await self.fetch_html(url)
            if not html:
                raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å HTML")

            cleaned_text, truncated, truncation_message = self.html_to_text(html)
            if not cleaned_text.strip():
                raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã")
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ –∫—ç—à (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º only_if_not_exists –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç race condition:
            # –µ—Å–ª–∏ –¥—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª —ç—Ç–æ—Ç URL, –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º
            if CACHE_AVAILABLE:
                await cache_service.set_cleaned_text(url, cleaned_text, only_if_not_exists=True)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —à–∞–≥–æ–≤ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—ç—à–∞)
        intermediate = None
        if use_cached and CACHE_AVAILABLE:
            intermediate = await cache_service.get_intermediate_steps(url)
        
        if intermediate:
            steps = [item.get("step", "") for item in intermediate]
        else:
            steps = await self.get_steps(cleaned_text)
            if not steps:
                raise ValueError("–ú–æ–¥–µ–ª—å –Ω–µ –≤–µ—Ä–Ω—É–ª–∞ —Å–ø–∏—Å–æ–∫ —à–∞–≥–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞")

            # üöÄ –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û–ï –í–´–ü–û–õ–ù–ï–ù–ò–ï –®–ê–ì–û–í –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –≤ 3-5 —Ä–∞–∑!
            print(f"[PARALLEL] Starting {len(steps)} steps in parallel...")
            tasks = [self.run_step_safe(step, cleaned_text) for step in steps]
            results = await asyncio.gather(*tasks)
            
            # –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–≤—Å–µ —É–∂–µ Dict, –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –≤ run_step_safe)
            intermediate = []
            for step, res in zip(steps, results):
                if "error" in res:
                    intermediate.append({"step": step, "error": res["error"]})
                    print(f"[PARALLEL] Step failed: {step[:50]}...")
                else:
                    intermediate.append({"step": step, "result": res})
                    print(f"[PARALLEL] Step completed: {step[:50]}...")
            
            print(f"[PARALLEL] All {len(steps)} steps completed!")
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —à–∞–≥–∏ –≤ –∫—ç—à (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º only_if_not_exists –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç race condition:
            # –µ—Å–ª–∏ –¥—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª —ç—Ç–æ—Ç URL, –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º
            if CACHE_AVAILABLE:
                await cache_service.set_intermediate_steps(url, intermediate, only_if_not_exists=True)

        final = await self.finalize(intermediate, cleaned_text, style, occasion)

        result = {
            "url": url,
            "style": style,
            "occasion": occasion,
            "steps": steps,
            "intermediate_results": intermediate,
            "final": final,
            "truncated": truncated,
            "truncation_message": truncation_message,
            "cached": False  # –§–ª–∞–≥ —á—Ç–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –∫—ç—à
        }
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫—ç—à (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
        if CACHE_AVAILABLE:
            await cache_service.set_analysis_result(url, style, occasion, result)
        return result

    def _get_mock_result(self, url: str, style: str, occasion: str) -> Dict[str, Any]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∏–∫—Ç–∏–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞.
        –ó–∞—à—É–Ω—Ç–∏—Ä—É–µ—Ç –±–ª–æ–∫–∏ 14 (–ø–∞—Ä—Å–∏–Ω–≥) –∏ 15 (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è) –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏.
        """
        # –§–∏–∫—Ç–∏–≤–Ω—ã–µ —à–∞–≥–∏ –∞–Ω–∞–ª–∏–∑–∞
        mock_steps = [
            "–ò–∑—É—á–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ —É—Å–ª—É–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Å–∞–π—Ç",
            "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –¥–∞–Ω–Ω—ã–µ, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞ —Å–∞–π—Ç–µ",
            "–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Ü–µ–ª–µ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é —Å–∞–π—Ç–∞ –∏ –∏—Ö –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏",
            "–í—ã—è–≤–∏—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å–∏—Å—Ç–µ–º—ã",
            "–°–æ—Å—Ç–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–æ–≤",
            "–†–∞–∑—Ä–∞–±–æ—Ç–∞–π—Ç–µ –∏–¥–µ–∏ –¥–ª—è –ø–æ—Å—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞—Ç—å —É—Å–ø–µ—à–Ω—ã–µ –∫–µ–π—Å—ã"
        ]
        
        # –§–∏–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        mock_intermediate = [
            {
                "step": mock_steps[0],
                "result": {
                    "–æ—Å–Ω–æ–≤–Ω—ã–µ_—É—Å–ª—É–≥–∏": "–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–æ—Å—Ç–æ–≤ –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π",
                    "–∫–ª—é—á–µ–≤—ã–µ_–ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞": "–ë—ã—Å—Ç—Ä–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è, 9 —Å—Ç–∏–ª–µ–π, —ç–∫—Å–ø–æ—Ä—Ç –≤ DOCX"
                }
            },
            {
                "step": mock_steps[1],
                "result": {
                    "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞": "–ë–æ–ª–µ–µ 1000 –¥–æ–≤–æ–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤",
                    "—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã": "–≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏ –¥–æ 90%"
                }
            },
            {
                "step": mock_steps[2],
                "result": {
                    "—Ü–µ–ª–µ–≤–∞—è_–∞—É–¥–∏—Ç–æ—Ä–∏—è": "–ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–∏, SMM-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã, –≤–ª–∞–¥–µ–ª—å—Ü—ã –±–∏–∑–Ω–µ—Å–∞",
                    "–ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏": "–ë—ã—Å—Ç—Ä–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞"
                }
            },
            {
                "step": mock_steps[3],
                "result": {
                    "—É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å": "–ì–∏–±—Ä–∏–¥–Ω—ã–π —Ä–µ–∂–∏–º LLM, —ç–∫–æ–Ω–æ–º–∏—è 94% –Ω–∞ —Ç–æ–∫–µ–Ω–∞—Ö",
                    "–ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞": "9 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ç–∏–ª–µ–π, —ç–∫—Å–ø–æ—Ä—Ç –≤ DOCX"
                }
            },
            {
                "step": mock_steps[4],
                "result": {
                    "–≤–æ–ø—Ä–æ—Å—ã": ["–°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–Ω–∏–º–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—è?", "–ö–∞–∫–∏–µ —Å—Ç–∏–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã?"],
                    "–≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è": ["–î–æ—Ä–æ–≥–æ", "–°–ª–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å"]
                }
            },
            {
                "step": mock_steps[5],
                "result": {
                    "–∏–¥–µ–∏": [
                        "–ö–µ–π—Å —É—Å–ø–µ—à–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞",
                        "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä—É—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏",
                        "–ü—Ä–∏–º–µ—Ä—ã –ø–æ—Å—Ç–æ–≤ –≤ —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∏–ª—è—Ö"
                    ]
                }
            }
        ]
        
        # –§–∏–∫—Ç–∏–≤–Ω—ã–µ –ø–æ—Å—Ç—ã (3 –≤–∞—Ä–∏–∞–Ω—Ç–∞, –∫–∞–∂–¥—ã–π 400-800 —Å–∏–º–≤–æ–ª–æ–≤)
        occasion_text = f" {occasion}" if occasion else ""
        mock_posts = [
            f"üöÄ –û—Ç–∫—Ä–æ–π—Ç–µ –¥–ª—è —Å–µ–±—è –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞!{occasion_text} –ù–∞—à –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–æ—Å—Ç–æ–≤ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π –≤—Å–µ–≥–æ –∑–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥. –ë–æ–ª–µ–µ 1000 –¥–æ–≤–æ–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ —É–∂–µ –æ—Ü–µ–Ω–∏–ª–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏! ‚ú® –ü–æ–ø—Ä–æ–±—É–π—Ç–µ 9 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ç–∏–ª–µ–π –∏ –Ω–∞–π–¥–∏—Ç–µ –∏–¥–µ–∞–ª—å–Ω—ã–π –¥–ª—è –≤–∞—à–µ–≥–æ –±—Ä–µ–Ω–¥–∞. –≠–∫–æ–Ω–æ–º—å—Ç–µ –¥–æ 90% –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞! üí™",
            f"üí° –ó–Ω–∞–µ—Ç–µ –ª–∏ –≤—ã, —á—Ç–æ –º–æ–∂–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç—ã –≤ 9 —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∏–ª—è—Ö?{occasion_text} –û—Ç —É–±–µ–¥–∏—Ç–µ–ª—å–Ω–æ-–ø–æ–∑–∏—Ç–∏–≤–Ω–æ–≥–æ –¥–æ –∏—Ä–æ–Ω–∏—á–Ω–æ–≥–æ - –Ω–∞—à –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ –ª—é–±–æ–π —Ç–æ–Ω –∏ –∞—É–¥–∏—Ç–æ—Ä–∏—é. –ì–∏–±—Ä–∏–¥–Ω—ã–π —Ä–µ–∂–∏–º LLM –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —ç–∫–æ–Ω–æ–º–∏—é 94% –Ω–∞ —Ç–æ–∫–µ–Ω–∞—Ö –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤—ã—Å–æ–∫–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞! üéØ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ DOCX –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏—Ö —Å—Ä–∞–∑—É. –ù–∞—á–Ω–∏—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç —É–∂–µ —Å–µ–≥–æ–¥–Ω—è! üìù",
            f"üé® –£—Å—Ç–∞–ª–∏ —Ç—Ä–∞—Ç–∏—Ç—å —á–∞—Å—ã –Ω–∞ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Å—Ç–æ–≤?{occasion_text} –ù–∞—à –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ä–µ—à–∞–µ—Ç —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É! –°–æ–∑–¥–∞–≤–∞–π—Ç–µ 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π –æ–±—ä–µ–º–æ–º 400-800 —Å–∏–º–≤–æ–ª–æ–≤ –∫–∞–∂–¥—ã–π, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–¥ –≤–∞—à –∏–Ω—Ñ–æ–ø–æ–≤–æ–¥. –ë–æ–ª–µ–µ 1000 –∫–ª–∏–µ–Ω—Ç–æ–≤ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–∞—à —Å–µ—Ä–≤–∏—Å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. ‚ú® –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –≤–∞—à–µ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏! üöÄ"
        ]
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ç–æ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–µ, —á—Ç–æ –∏ —Ä–µ–∞–ª—å–Ω—ã–π
        mock_final = {
            "posts": mock_posts
        }
        
        return {
            "url": url,
            "style": style,
            "occasion": occasion,
            "steps": mock_steps,
            "intermediate_results": mock_intermediate,
            "final": mock_final,
            "truncated": False,
            "truncation_message": None,
            "cached": False
        }


