name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ UI GitHub

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.VPS_SSH_PORT || 22 }} -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: –û—Ç–ø—Ä–∞–≤–∫–∞ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è - –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è
        # Temporarily disabled
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B)
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è%0A%0Aüì¶ –ö–æ–º–º–∏—Ç: ${COMMIT_SHA}%0Aüìù –°–æ–æ–±—â–µ–Ω–∏–µ: ${COMMIT_MSG}" \
            -d parse_mode="HTML" || true

      - name: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT || 22 }}
        run: |
          echo "üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º..."
          echo "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—É—Ç—å: /root/public"
          
          ssh -p $VPS_SSH_PORT -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST bash << EOF
            cd /root/public || exit 1

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç –≤ —Ñ–∞–π–ª .previous_version
            CURRENT_COMMIT=\$(git rev-parse HEAD 2>/dev/null || echo "")
            if [ -n "\$CURRENT_COMMIT" ]; then
              echo "\$CURRENT_COMMIT" > .previous_version
              echo "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤–µ—Ä—Å–∏—è: \$(git rev-parse --short HEAD)"
            else
              echo "‚ö†Ô∏è  Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—É—Å—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏"
            fi
          EOF

      - name: üß® –Ø–î–ï–†–ù–ê–Ø –û–ß–ò–°–¢–ö–ê Docker (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT || 22 }}
        run: |
          echo "üß® –Ø–î–ï–†–ù–ê–Ø –û–ß–ò–°–¢–ö–ê Docker (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–±—Ä–∞–∑—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã)..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã
          ssh -p $VPS_SSH_PORT -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST bash << 'NUCLEAR_CLEANUP'
            set -e
            
            cd /root/public || exit 1
            
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤..."
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—Ä–∞–∑—ã —Å :latest –∏ —Å –ª—é–±—ã–º–∏ —Ç–µ–≥–∞–º–∏
            BLOCKED_IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "public-(backend|frontend|admin-frontend)" | wc -l || echo "0")
            
            if [ "$BLOCKED_IMAGES" -gt 0 ] 2>/dev/null; then
              echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω–æ $BLOCKED_IMAGES –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤"
              echo "üß® –í–´–ü–û–õ–ù–Ø–ï–ú –ü–û–õ–ù–´–ô –°–ë–†–û–° DOCKER..."
              
              # 1. –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –í–°–Å
              echo "  1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
              docker compose down 2>/dev/null || true
              docker stop $(docker ps -aq) 2>/dev/null || true
              
              # 2. –£–î–ê–õ–Ø–ï–ú –í–°–ï –ö–û–ù–¢–ï–ô–ù–ï–†–´
              echo "  2. –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
              docker rm -f $(docker ps -aq) 2>/dev/null || true
              
              # 3. –£–î–ê–õ–Ø–ï–ú –í–°–ï –û–ë–†–ê–ó–´ (–æ—Å–æ–±–µ–Ω–Ω–æ :latest)
              echo "  3. –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –æ–±—Ä–∞–∑–æ–≤..."
              # –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º –æ–±—Ä–∞–∑—ã –ø—Ä–æ–µ–∫—Ç–∞ —Å :latest
              docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "public-(backend|frontend|admin-frontend):latest" | xargs -r docker rmi -f 2>/dev/null || true
              # –ó–∞—Ç–µ–º –≤—Å–µ –æ–±—Ä–∞–∑—ã –ø—Ä–æ–µ–∫—Ç–∞
              docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "public-(backend|frontend|admin-frontend)" | xargs -r docker rmi -f 2>/dev/null || true
              # –ó–∞—Ç–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–∑—ã
              docker rmi -f $(docker images -q) 2>/dev/null || true
              
              # 4. –û–ß–ò–©–ê–ï–ú –í–°–ï VOLUMES (–∫—Ä–æ–º–µ –≤–∞–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
              echo "  4. –û—á–∏—Å—Ç–∫–∞ volumes..."
              docker volume prune -f || true
              
              # 5. –ü–û–õ–ù–´–ô –°–ë–†–û–° DOCKER (–Ø–î–ï–†–ù–û–ï –†–ï–®–ï–ù–ò–ï)
              echo "  5. –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å Docker (–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª—É–∂–±—ã)..."
              systemctl stop docker || service docker stop || true
              
              echo "  6. –û—á–∏—Å—Ç–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ Docker..."
              # –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ build cache –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã, –ù–ï —É–¥–∞–ª—è–µ–º volumes
              rm -rf /var/lib/docker/buildkit/* 2>/dev/null || true
              rm -rf /var/lib/docker/tmp/* 2>/dev/null || true
              rm -rf /var/lib/docker/overlay2/* 2>/dev/null || true
              
              echo "  7. –ó–∞–ø—É—Å–∫ Docker..."
              systemctl start docker || service docker start || true
              
              echo "  8. –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Docker..."
              sleep 15
              
              # 9. –ü–†–û–í–ï–†–Ø–ï–ú
              echo "  9. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è Docker..."
              docker info > /dev/null 2>&1 || {
                echo "  ‚ö†Ô∏è  Docker –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è, –∂–¥–µ–º –µ—â–µ..."
                sleep 10
                docker info || echo "  ‚ùå Docker –≤—Å–µ –µ—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
              }
              
              echo "‚úÖ –Ø–¥–µ—Ä–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
            else
              echo "‚úÖ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —è–¥–µ—Ä–Ω—É—é –æ—á–∏—Å—Ç–∫—É"
            fi
          NUCLEAR_CLEANUP

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT || 22 }}
          UNIQUE_TAG: github-${{ github.run_id }}-${{ github.run_attempt }}
          DEPLOY_ID: deploy-${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è –Ω–∞ VPS..."
          echo "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—É—Ç—å: /root/public"
          echo "üè∑Ô∏è  –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–µ–≥: $UNIQUE_TAG"
          echo "üÜî –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–µ–ø–ª–æ—è: $DEPLOY_ID"

          # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –¥–µ–ø–ª–æ—è —á–µ—Ä–µ–∑ SSH —Å –ø–µ—Ä–µ–¥–∞—á–µ–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
          ssh -p $VPS_SSH_PORT -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST bash << EOF
            set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
            
            # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–µ–≥ –∏ ID –¥–µ–ø–ª–æ—è
            export UNIQUE_TAG="$UNIQUE_TAG"
            export DEPLOY_ID="$DEPLOY_ID"
            echo "üè∑Ô∏è  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ–≥: \$UNIQUE_TAG"
            echo "üÜî –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ID –¥–µ–ø–ª–æ—è: \$DEPLOY_ID"

            # –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd /root/public || {
              echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é /root/public"
              exit 1
            }

            echo "üìÇ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: \$(pwd)"

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è docker-compose.yml
            if [ ! -f "docker-compose.yml" ]; then
              echo "‚ùå –û—à–∏–±–∫–∞: docker-compose.yml –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ \$(pwd)"
              exit 1
            fi

            # –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ Git
            echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ Git..."
            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —Å–ª–∏—è–Ω–∏—è –¥–ª—è git pull
            git config pull.rebase false || true
            git fetch origin || {
              echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ git fetch"
              exit 1
            }
            # –ü—Ä–æ–±—É–µ–º pull —Å merge —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π
            git pull origin main --no-rebase || {
              echo "‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø—Ä–∏ git pull, –ø—Ä–æ–±—É–µ–º reset –∏ pull..."
              # –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, –¥–µ–ª–∞–µ–º hard reset
              git reset --hard origin/main || {
                echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ git pull/reset"
                exit 1
              }
            }
            echo "‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"

            # –®–∞–≥ 2: –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–ê–Ø –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ —Å–µ—Ç–µ–π
            echo "üõë –ì–ª—É–±–æ–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ Docker..."
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–≤–∫–ª—é—á–∞—è —Å–∫—Ä—ã—Ç—ã–µ)
            echo "  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            docker stop $(docker ps -aq) 2>/dev/null || echo "  –ù–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
            
            # –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "  –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            docker rm -f $(docker ps -aq) 2>/dev/null || echo "  –ù–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è"
            
            # –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–µ—Ç–∏ (–∫—Ä–æ–º–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö)
            echo "  –û—á–∏—Å—Ç–∫–∞ —Å–µ—Ç–µ–π..."
            docker network prune -f || true
            
            # Docker compose down –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ compose-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            echo "  Docker compose down..."
            docker compose down --remove-orphans 2>/dev/null || echo "  Compose –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω"
            
            # –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã Docker
            echo "  –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ Docker system..."
            docker system prune -a -f --volumes || echo "  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å system prune"
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ - —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø–æ –∏–º–µ–Ω–∞–º
            echo "üßπ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–æ –∏–º–µ–Ω–∞–º..."
            for name in public-redis public-backend public-frontend public-admin-frontend public-redis-commander; do
              echo "  –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: $name"
              # –£–¥–∞–ª—è–µ–º –ø–æ –∏–º–µ–Ω–∏
              docker rm -f "$name" 2>/dev/null || true
              # –£–¥–∞–ª—è–µ–º –ø–æ ID –µ—Å–ª–∏ –∏–º—è –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ
              CONTAINER_ID=$(docker ps -aq --filter "name=^${name}$" 2>/dev/null)
              if [ -n "$CONTAINER_ID" ]; then
                echo "    –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ ID: $CONTAINER_ID"
                docker rm -f "$CONTAINER_ID" 2>/dev/null || true
              fi
            done
            
            # –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å "public" –≤ –∏–º–µ–Ω–∏
            echo "  –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å 'public' –≤ –∏–º–µ–Ω–∏..."
            docker ps -a --format "{{.ID}} {{.Names}}" 2>/dev/null | grep -E "public" | awk '{print $1}' | while read -r id; do
              if [ -n "$id" ]; then
                echo "    –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø–æ ID: $id"
                docker rm -f "$id" 2>/dev/null || true
              fi
            done || true
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É–¥–∞–ª–µ–Ω—ã
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏..."
            echo "  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:"
            docker ps -a || echo "  –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
            echo "  –°–µ—Ç–∏:"
            docker network ls || echo "  –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–µ—Ç–µ–π"

            # –®–∞–≥ 3: –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê Docker –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–æ–π
            echo "üóëÔ∏è  –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê Docker –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–æ–π..."
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            docker compose down --remove-orphans 2>/dev/null || true
            
            # –£–¥–∞–ª—è–µ–º –≤—Å–µ –æ–±—Ä–∞–∑—ã –ø—Ä–æ–µ–∫—Ç–∞ —á–µ—Ä–µ–∑ docker images | grep
            echo "  –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –æ–±—Ä–∞–∑–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ —á–µ—Ä–µ–∑ grep..."
            docker images | grep "public-" | awk '{print $3}' | xargs -r docker rmi -f 2>/dev/null || true
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º docker compose down —Å —É–¥–∞–ª–µ–Ω–∏–µ–º –≤—Å–µ—Ö –æ–±—Ä–∞–∑–æ–≤
            echo "  Docker compose down --rmi all..."
            docker compose down --rmi all --volumes --remove-orphans 2>/dev/null || true
            
            # –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–∑—ã —á–µ—Ä–µ–∑ docker images –∏ xargs (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ)
            echo "  –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –æ–±—Ä–∞–∑–æ–≤ —Å 'public' —á–µ—Ä–µ–∑ docker images..."
            docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "public-" | xargs -r docker rmi -f 2>/dev/null || true
            docker images --format "{{.ID}} {{.Repository}}" | grep -E "public" | awk '{print $1}' | xargs -r docker rmi -f 2>/dev/null || true
            
            # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏–º–µ–Ω–∞–º
            for image in public-backend public-frontend public-admin-frontend; do
              echo "  –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–∞: $image"
              # –ü—Ä–æ–±—É–µ–º —É–¥–∞–ª–∏—Ç—å –ø–æ –ø–æ–ª–Ω–æ–º—É –∏–º–µ–Ω–∏ —Å —Ç–µ–≥–æ–º
              docker rmi -f "${image}:latest" 2>/dev/null || true
              # –ü—Ä–æ–±—É–µ–º —É–¥–∞–ª–∏—Ç—å –±–µ–∑ —Ç–µ–≥–∞
              docker rmi -f "$image" 2>/dev/null || true
              # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∏ —É–¥–∞–ª–∏—Ç—å –ø–æ ID (–≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã)
              docker images --format "{{.ID}} {{.Repository}}" | grep " ${image}$" | awk '{print $1}' | xargs -r docker rmi -f 2>/dev/null || true
            done
            
            # –ü–û–õ–ù–ê–Ø –æ—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã Docker
            echo "  –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ Docker system (prune -a -f --volumes)..."
            docker system prune -a -f --volumes 2>/dev/null || echo "  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω—É—é –æ—á–∏—Å—Ç–∫—É"
            
            # –£–¥–∞–ª—è–µ–º dangling images
            echo "  –û—á–∏—Å—Ç–∫–∞ dangling images..."
            docker image prune -f || true
            
            # –û—á–∏—â–∞–µ–º build cache
            echo "  –û—á–∏—Å—Ç–∫–∞ build cache..."
            docker builder prune -f || true
            
            # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
            echo "  –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤..."
            REMAINING_IMAGES=$(docker images --format "{{.Repository}}" | grep -E "public-" | wc -l || echo "0")
            if [ -n "$REMAINING_IMAGES" ] && [ "$REMAINING_IMAGES" -gt 0 ] 2>/dev/null; then
              echo "  ‚ö†Ô∏è  –í—Å–µ –µ—â–µ –æ—Å—Ç–∞–ª–æ—Å—å $REMAINING_IMAGES –æ–±—Ä–∞–∑–æ–≤, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ..."
              # –ü—Ä–æ–±—É–µ–º —É–¥–∞–ª–∏—Ç—å —á–µ—Ä–µ–∑ docker image rm
              docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "public-" | xargs -r docker image rm -f 2>/dev/null || true
              # –ü—Ä–æ–±—É–µ–º —É–¥–∞–ª–∏—Ç—å —á–µ—Ä–µ–∑ ID
              docker images --format "{{.ID}} {{.Repository}}" | grep -E "public-" | awk '{print $1}' | xargs -r docker image rm -f 2>/dev/null || true
              # –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ docker images | grep
              docker images | grep "public-" | awk '{print $3}' | xargs -r docker rmi -f 2>/dev/null || true
            fi
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –æ–±—Ä–∞–∑—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            echo "  –°–ø–∏—Å–æ–∫ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –æ–±—Ä–∞–∑–æ–≤:"
            docker images | grep -E "public|REPOSITORY" || echo "  –ù–µ—Ç –æ–±—Ä–∞–∑–æ–≤ —Å 'public'"
            
            # –®–∞–≥ 5: –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤
            echo "üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤..."
            # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤ –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π
            echo "  –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤ –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π..."
            docker images | grep -E "public-|REPOSITORY" || echo "  –ù–µ—Ç –æ–±—Ä–∞–∑–æ–≤ —Å 'public'"
            # –ï—Å–ª–∏ –æ–±—Ä–∞–∑—ã –≤—Å–µ –µ—â–µ –µ—Å—Ç—å, —É–¥–∞–ª—è–µ–º –∏—Ö –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
            docker images | grep "public-" | awk '{print $3}' | xargs -r docker rmi -f 2>/dev/null || true
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —á–µ—Ä–µ–∑ docker image rm
            docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "public-" | xargs -r docker image rm -f 2>/dev/null || true
            
            # –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–ß–ò–°–¢–ö–ê: –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–∑—ã –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏–º–µ–Ω–∞–º –ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π
            echo "  üî• –§–∏–Ω–∞–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤ –ø–æ –∏–º–µ–Ω–∞–º –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π..."
            for img_name in public-backend:latest public-frontend:latest public-admin-frontend:latest; do
              echo "    –£–¥–∞–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–∞: $img_name"
              docker image rm -f "$img_name" 2>/dev/null || true
              # –¢–∞–∫–∂–µ –ø—Ä–æ–±—É–µ–º —É–¥–∞–ª–∏—Ç—å –±–µ–∑ —Ç–µ–≥–∞
              docker image rm -f "${img_name%:*}" 2>/dev/null || true
              # –£–¥–∞–ª—è–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —á–µ—Ä–µ–∑ ID
              docker images --format "{{.ID}} {{.Repository}}:{{.Tag}}" | grep "$img_name" | awk '{print $1}' | xargs -r docker image rm -f 2>/dev/null || true
            done
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –æ–±—Ä–∞–∑—ã —É–¥–∞–ª–µ–Ω—ã
            echo "  –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤..."
            REMAINING=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "public-(backend|frontend|admin-frontend):latest" | wc -l || echo "0")
            if [ "$REMAINING" -gt 0 ] 2>/dev/null; then
              echo "  ‚ö†Ô∏è  –í—Å–µ –µ—â–µ –æ—Å—Ç–∞–ª–æ—Å—å $REMAINING –æ–±—Ä–∞–∑–æ–≤, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ..."
              docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "public-(backend|frontend|admin-frontend):latest" | xargs -r docker image rm -f 2>/dev/null || true
            fi
            echo "  ‚úÖ –û–±—Ä–∞–∑—ã —É–¥–∞–ª–µ–Ω—ã –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π"
            
            # –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–ß–ò–°–¢–ö–ê: –£–¥–∞–ª—è–µ–º –≤—Å–µ –æ–±—Ä–∞–∑—ã —Å —Ç–µ–≥–æ–º latest
            echo "  üî• –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –æ–±—Ä–∞–∑–æ–≤ —Å —Ç–µ–≥–æ–º :latest..."
            docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "public-(backend|frontend|admin-frontend):latest" | xargs -r docker rmi -f 2>/dev/null || true
            docker images --format "{{.ID}} {{.Repository}}:{{.Tag}}" | grep -E "public-(backend|frontend|admin-frontend).*latest" | awk '{print $1}' | xargs -r docker rmi -f 2>/dev/null || true
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ–±—Ä–∞–∑—ã —É–¥–∞–ª–µ–Ω—ã
            echo "  –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤ :latest..."
            docker images | grep -E "public-(backend|frontend|admin-frontend).*latest" || echo "  ‚úÖ –û–±—Ä–∞–∑—ã :latest —É–¥–∞–ª–µ–Ω—ã"
            
            # –°–±–æ—Ä–∫–∞ —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º —É–¥–∞–ª–µ–Ω–∏–µ–º —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤ (–ø–µ—Ä–µ–¥–∞–µ–º UNIQUE_TAG –∏ DEPLOY_ID —è–≤–Ω–æ)
            echo "üî® –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤ —Å —Ç–µ–≥–æ–º: \$UNIQUE_TAG –∏ ID: \$DEPLOY_ID"
            COMPOSE_PROJECT_NAME=public UNIQUE_TAG="\$UNIQUE_TAG" DEPLOY_ID="\$DEPLOY_ID" docker compose build --no-cache --pull --progress=plain --force-rm || {
              echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–µ –æ–±—Ä–∞–∑–æ–≤"
              echo "üìã –ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤ –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Å–±–æ—Ä–∫–∏..."
              # –ï—Å–ª–∏ —Å–±–æ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å –∏–∑-–∑–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ–±—Ä–∞–∑–æ–≤, —É–¥–∞–ª—è–µ–º –∏—Ö –∏ –ø—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑
              docker images | grep "public-" | awk '{print $3}' | xargs -r docker rmi -f 2>/dev/null || true
              docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "public-" | xargs -r docker image rm -f 2>/dev/null || true
              # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Å–±–æ—Ä–∫–æ–π
              echo "  üî• –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –æ–±—Ä–∞–∑–æ–≤ :latest –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Å–±–æ—Ä–∫–æ–π..."
              docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "public-(backend|frontend|admin-frontend):latest" | xargs -r docker rmi -f 2>/dev/null || true
              
              # –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å–±–æ—Ä–∫–∏ (–ø–µ—Ä–µ–¥–∞–µ–º UNIQUE_TAG –∏ DEPLOY_ID —è–≤–Ω–æ)
              COMPOSE_PROJECT_NAME=public UNIQUE_TAG="\$UNIQUE_TAG" DEPLOY_ID="\$DEPLOY_ID" docker compose build --no-cache --pull --progress=plain --force-rm || {
                echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–µ—Ä–µ—Å–±–æ—Ä–∫–µ –æ–±—Ä–∞–∑–æ–≤"
                docker compose logs
                exit 1
              }
            }
            echo "‚úÖ –û–±—Ä–∞–∑—ã –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω—ã"

            # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
            echo "üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º..."
            # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø–æ –∏–º–µ–Ω–∞–º
            for name in public-redis public-backend public-frontend public-admin-frontend public-redis-commander; do
              if docker ps -a --format "{{.Names}}" | grep -q "^${name}$"; then
                echo "  ‚ö†Ô∏è  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä $name –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ..."
                docker rm -f "$name" || true
                # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ ID, –µ—Å–ª–∏ –∏–º—è –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ
                CONTAINER_ID=$(docker ps -a --filter "name=^${name}$" --format "{{.ID}}")
                if [ -n "$CONTAINER_ID" ]; then
                  echo "    –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ ID: $CONTAINER_ID"
                  docker rm -f "$CONTAINER_ID" || true
                fi
              fi
            done
            
            # –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å "public" –≤ –∏–º–µ–Ω–∏ –µ—â–µ —Ä–∞–∑ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            echo "  –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å 'public'..."
            docker ps -a --format "{{.ID}} {{.Names}}" | grep "public" | awk '{print $1}' | while read -r id; do
              if [ -n "$id" ]; then
                echo "    –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø–æ ID: $id"
                docker rm -f "$id" || true
              fi
            done || true
            
            # –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–µ—Ç–µ–π
            echo "  –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–µ—Ç–µ–π..."
            docker network ls --format "{{.ID}} {{.Name}}" | grep "public" | awk '{print $1}' | while read -r network_id; do
              if [ -n "$network_id" ]; then
                echo "    –£–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Ç–∏ –ø–æ ID: $network_id"
                docker network rm "$network_id" || true
              fi
            done || true

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ docker-compose.yml..."
            echo "=== –°–æ–¥–µ—Ä–∂–∏–º–æ–µ docker-compose.yml (—Å–µ–∫—Ü–∏—è redis) ==="
            grep -A 15 "^  redis:" docker-compose.yml || echo "–°–µ–∫—Ü–∏—è redis –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            
            # –®–∞–≥ 4: –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –ö–û–ù–¢–ï–ô–ù–ï–†–û–í –ü–ï–†–ï–î –ó–ê–ü–£–°–ö–û–ú
            echo "üßπ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –í–°–ï–• —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º..."
            
            # –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ docker compose
            docker compose down --remove-orphans 2>/dev/null || true
            
            # –£–¥–∞–ª—è–µ–º –∫–∞–∂–¥—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏
            for container_name in public-frontend public-backend public-admin-frontend public-redis public-redis-commander; do
              echo "  –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: $container_name"
              docker rm -f "$container_name" 2>/dev/null || true
              # –¢–∞–∫–∂–µ —É–¥–∞–ª—è–µ–º –ø–æ ID –µ—Å–ª–∏ –∏–º—è –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ
              CONTAINER_ID=$(docker ps -aq --filter "name=^${container_name}$" 2>/dev/null || echo "")
              if [ -n "$CONTAINER_ID" ]; then
                echo "    –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ ID: $CONTAINER_ID"
                docker rm -f "$CONTAINER_ID" 2>/dev/null || true
              fi
            done
            
            # –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å "public" –≤ –∏–º–µ–Ω–∏
            docker ps -a --format "{{.ID}} {{.Names}}" 2>/dev/null | grep -E "public" | awk '{print $1}' | xargs -r docker rm -f 2>/dev/null || true
            
            # –£–¥–∞–ª—è–µ–º —Å–µ—Ç—å –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∞—Å—å
            docker network rm public_public-network 2>/dev/null || true
            
            echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
            
            # –®–∞–≥ 5: –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –≤–º–µ—Å—Ç–µ (Docker Compose —Å–∞–º —Ä–∞–∑–±–µ—Ä–µ—Ç—Å—è —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏)
            echo "üöÄ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤..."
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ Redis –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–¥–∞–ª–µ–Ω
            echo "  üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ Redis –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
            if docker ps -a --format "{{.Names}}" | grep -q "^public-redis$"; then
              echo "  ‚ö†Ô∏è  Redis –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ..."
              docker stop public-redis 2>/dev/null || true
              docker rm -f public-redis 2>/dev/null || true
              # –¢–∞–∫–∂–µ —É–¥–∞–ª—è–µ–º –ø–æ ID
              REDIS_ID=$(docker ps -aq --filter "name=^public-redis$" 2>/dev/null || echo "")
              if [ -n "$REDIS_ID" ]; then
                echo "    –£–¥–∞–ª–µ–Ω–∏–µ Redis –ø–æ ID: $REDIS_ID"
                docker rm -f "$REDIS_ID" 2>/dev/null || true
              fi
            fi
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –≤–º–µ—Å—Ç–µ - Docker Compose —Å–∞–º —Ä–∞–∑–±–µ—Ä–µ—Ç—Å—è —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
            COMPOSE_PROJECT_NAME=public UNIQUE_TAG="\$UNIQUE_TAG" DEPLOY_ID="\$DEPLOY_ID" docker compose up -d --force-recreate --remove-orphans || {
              echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
              echo "üìã –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
              docker ps -a
              echo "üìã –°—Ç–∞—Ç—É—Å compose:"
              docker compose ps
              
              # –ü—Ä–æ–≤–µ—Ä–∫–∞ .env —Ñ–∞–π–ª–∞
              echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ .env —Ñ–∞–π–ª–∞:"
              if [ -f ".env" ]; then
                echo "  ‚úÖ .env —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
                echo "  –ü–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫ (–±–µ–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤):"
                head -5 .env | sed 's/=.*/=***/' || echo "  –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å .env"
              else
                echo "  ‚ùå .env —Ñ–∞–π–ª –ù–ï –ù–ê–ô–î–ï–ù!"
              fi
              
              # –õ–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
              echo "üìã –õ–æ–≥–∏ Redis:"
              docker compose logs redis --tail=50 2>&1 || echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä Redis –Ω–µ –Ω–∞–π–¥–µ–Ω"
              
              echo "üìã –õ–æ–≥–∏ Backend:"
              BACKEND_CONTAINER_NAME="public-backend\${DEPLOY_ID:+-${DEPLOY_ID}}"
              docker compose logs backend --tail=100 2>&1 || {
                echo "  –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
                docker ps -a | grep backend || echo "  Backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"
                # –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ —á–µ—Ä–µ–∑ docker logs
                docker ps -a --format "{{.Names}}" | grep backend | head -1 | xargs -I {} docker logs {} --tail=100 2>&1 || echo "  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ backend"
              }
              
              echo "üìã –õ–æ–≥–∏ Frontend:"
              docker compose logs frontend --tail=50 2>&1 || echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä Frontend –Ω–µ –Ω–∞–π–¥–µ–Ω"
              
              echo "üìã –õ–æ–≥–∏ Admin Frontend:"
              docker compose logs admin-frontend --tail=50 2>&1 || echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä Admin Frontend –Ω–µ –Ω–∞–π–¥–µ–Ω"
              
              # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
              echo "üìã –î–µ—Ç–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
              docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.ExitCode}}" | grep -E "NAMES|public" || docker ps -a
              
              echo "üìã –í—Å–µ –ª–æ–≥–∏ compose:"
              docker compose logs --tail=50
              exit 1
            }
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞
            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (30 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏)..."
            sleep 30
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è Redis
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è Redis..."
            REDIS_HEALTHY=false
            for i in {1..20}; do
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ docker inspect
              HEALTH_STATUS=$(docker inspect --format='{{.State.Health.Status}}' public-redis 2>/dev/null || echo "none")
              if [ "$HEALTH_STATUS" = "healthy" ]; then
                echo "  ‚úÖ Redis –∑–¥–æ—Ä–æ–≤ (—Å—Ç–∞—Ç—É—Å: $HEALTH_STATUS)"
                REDIS_HEALTHY=true
                break
              elif [ "$HEALTH_STATUS" = "starting" ] || [ "$HEALTH_STATUS" = "none" ]; then
                echo "  ‚è≥ Redis –µ—â–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è (—Å—Ç–∞—Ç—É—Å: $HEALTH_STATUS)... $i/20"
              else
                echo "  ‚ö†Ô∏è  Redis —Å—Ç–∞—Ç—É—Å: $HEALTH_STATUS, –ø—Ä–æ–≤–µ—Ä—è–µ–º ping..."
                if docker compose exec -T redis redis-cli ping 2>/dev/null | grep -q "PONG"; then
                  echo "  ‚úÖ Redis –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ ping, –Ω–æ —Å—Ç–∞—Ç—É—Å healthcheck: $HEALTH_STATUS"
                  REDIS_HEALTHY=true
                  break
                fi
              fi
              sleep 2
            done
            
            if [ "$REDIS_HEALTHY" != "true" ]; then
              echo "  ‚ö†Ô∏è  Redis –Ω–µ —Å—Ç–∞–ª healthy, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º (–º–æ–∂–µ—Ç –±—ã—Ç—å –µ—â–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è)..."
              echo "  üìã –õ–æ–≥–∏ Redis:"
              docker compose logs redis --tail=20
            fi
            
            echo "=== –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê –í–°–ï–• –ö–û–ù–¢–ï–ô–ù–ï–†–û–í ==="
            docker compose ps
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –æ—Ç–¥–µ–ª—å–Ω–æ
            echo ""
            echo "=== –î–ï–¢–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –°–ï–†–í–ò–°–û–í ==="
            for service in redis backend frontend admin-frontend redis-commander; do
              echo ""
              echo "--- –ü—Ä–æ–≤–µ—Ä–∫–∞ $service ---"
              if docker compose ps $service 2>/dev/null | grep -q "Up"; then
                echo "‚úÖ $service –∑–∞–ø—É—â–µ–Ω"
                echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞:"
                docker compose logs --tail=10 $service 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏"
              else
                echo "‚ùå $service –ù–ï –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω"
                echo "–ü–æ–ª–Ω—ã–π –ª–æ–≥:"
                docker compose logs $service 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏"
                # –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ —á–µ—Ä–µ–∑ docker logs
                CONTAINER_NAME="public-$service"
                if docker ps -a --format "{{.Names}}" | grep -q "^${CONTAINER_NAME}$"; then
                  echo "–õ–æ–≥–∏ —á–µ—Ä–µ–∑ docker logs:"
                  docker logs "$CONTAINER_NAME" 2>&1 | tail -20 || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏"
                fi
              fi
            done
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
            echo ""
            echo "=== –ü–†–û–í–ï–†–ö–ê –î–û–°–¢–£–ü–ù–û–°–¢–ò –°–ï–†–í–ò–°–û–í ==="
            
            # Redis
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ Redis..."
            if docker compose exec -T redis redis-cli ping 2>/dev/null | grep -q "PONG"; then
              echo "‚úÖ Redis –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ ping"
            else
              echo "‚ùå Redis –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ ping"
              docker compose logs redis --tail=20
            fi
            
            # Backend
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ Backend..."
            if docker compose exec -T backend curl -f http://localhost:8000/health 2>/dev/null > /dev/null; then
              echo "‚úÖ Backend health check –ø—Ä–æ—à–µ–ª"
            else
              echo "‚ö†Ô∏è  Backend health check –Ω–µ –ø—Ä–æ—à–µ–ª (–º–æ–∂–µ—Ç –±—ã—Ç—å –µ—â–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è)"
              docker compose logs backend --tail=20
            fi
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å
            echo ""
            echo "=== –û–ë–©–ò–ô –°–¢–ê–¢–£–° ==="
            docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "NAMES|public" || docker ps -a
            echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã"

            # –®–∞–≥ 5: –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (60 —Å–µ–∫—É–Ω–¥)..."
            sleep 60

            # –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            docker compose ps

            echo "‚úÖ –î–µ–ø–ª–æ–π –Ω–∞ VPS –∑–∞–≤–µ—Ä—à–µ–Ω"
          EOF

      - name: Health Check - Backend (—Å retry –ª–æ–≥–∏–∫–æ–π)
        id: health_backend
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          BACKEND_PORT: ${{ secrets.BACKEND_PORT || '8000' }}
        run: |
          echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è Backend..."
          max_attempts=30
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            if curl -f -s --max-time 5 "http://$VPS_HOST:$BACKEND_PORT/health" > /dev/null 2>&1; then
              echo "‚úÖ Backend –∑–¥–æ—Ä–æ–≤ (–ø–æ–ø—ã—Ç–∫–∞ $attempt/$max_attempts)"
              echo "backend_status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç Backend (–ø–æ–ø—ã—Ç–∫–∞ $attempt/$max_attempts)..."
            sleep 2
            attempt=$((attempt + 1))
          done

          echo "‚ùå Backend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ $max_attempts –ø–æ–ø—ã—Ç–æ–∫"
          echo "backend_status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: Health Check - Frontend (—Å retry –ª–æ–≥–∏–∫–æ–π)
        id: health_frontend
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          FRONTEND_PORT: ${{ secrets.FRONTEND_PORT || '3000' }}
        run: |
          echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è Frontend..."
          max_attempts=30
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            if curl -f -s --max-time 5 "http://$VPS_HOST:$FRONTEND_PORT" > /dev/null 2>&1; then
              echo "‚úÖ Frontend –¥–æ—Å—Ç—É–ø–µ–Ω (–ø–æ–ø—ã—Ç–∫–∞ $attempt/$max_attempts)"
              echo "frontend_status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç Frontend (–ø–æ–ø—ã—Ç–∫–∞ $attempt/$max_attempts)..."
            sleep 2
            attempt=$((attempt + 1))
          done

          echo "‚ùå Frontend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ $max_attempts –ø–æ–ø—ã—Ç–æ–∫"
          echo "frontend_status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: Health Check - Admin Frontend (—Å retry –ª–æ–≥–∏–∫–æ–π)
        id: health_admin
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          ADMIN_FRONTEND_PORT: ${{ secrets.ADMIN_FRONTEND_PORT || '3001' }}
        run: |
          echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è Admin Frontend..."
          max_attempts=30
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            if curl -f -s --max-time 5 "http://$VPS_HOST:$ADMIN_FRONTEND_PORT" > /dev/null 2>&1; then
              echo "‚úÖ Admin Frontend –¥–æ—Å—Ç—É–ø–µ–Ω (–ø–æ–ø—ã—Ç–∫–∞ $attempt/$max_attempts)"
              echo "admin_status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç Admin Frontend (–ø–æ–ø—ã—Ç–∫–∞ $attempt/$max_attempts)..."
            sleep 2
            attempt=$((attempt + 1))
          done

          echo "‚ùå Admin Frontend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ $max_attempts –ø–æ–ø—ã—Ç–æ–∫"
          echo "admin_status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: –û—á–∏—Å—Ç–∫–∞ Docker (–ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è)
        if: success()
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT || 22 }}
        run: |
          echo "üßπ –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö Docker —Ä–µ—Å—É—Ä—Å–æ–≤..."
          ssh -p $VPS_SSH_PORT -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST bash << EOF
            # –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—Ä–∞–∑–æ–≤, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, —Å–µ—Ç–µ–π –∏ volumes
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º -af –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
            docker system prune -af || echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å Docker"
            echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ Docker –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
          EOF

      - name: –û—Ç–ø—Ä–∞–≤–∫–∞ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è - –£—Å–ø–µ—à–Ω—ã–π –¥–µ–ø–ª–æ–π
        # Temporarily disabled
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B)
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω%0A%0Aüì¶ –ö–æ–º–º–∏—Ç: ${COMMIT_SHA}%0Aüìù –°–æ–æ–±—â–µ–Ω–∏–µ: ${COMMIT_MSG}%0Aüåê VPS: ${VPS_HOST}" \
            -d parse_mode="HTML" || true

      - name: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
        if: failure()
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT || 22 }}
        run: |
          echo "üîÑ –ù–∞—á–∞–ª–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç–∫–∞—Ç–∞ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏..."
          echo "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—É—Ç—å: /root/public"

          ssh -p $VPS_SSH_PORT -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST bash << EOF
            set +e  # –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
            cd /root/public || {
              echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é /root/public"
              exit 1
            }

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–µ–π
            if [ ! -f ".previous_version" ]; then
              echo "‚ö†Ô∏è  –§–∞–π–ª .previous_version –Ω–µ –Ω–∞–π–¥–µ–Ω, –æ—Ç–∫–∞—Ç –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω"
              exit 0  # –í—ã—Ö–æ–¥–∏–º –±–µ–∑ –æ—à–∏–±–∫–∏, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
            fi

            PREVIOUS_COMMIT=\$(cat .previous_version)
            if [ -z "\$PREVIOUS_COMMIT" ]; then
              echo "‚ö†Ô∏è  –ü—Ä–µ–¥—ã–¥—É—â–∞—è –≤–µ—Ä—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ .previous_version"
              exit 0  # –í—ã—Ö–æ–¥–∏–º –±–µ–∑ –æ—à–∏–±–∫–∏, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
            fi

            echo "üì¶ –û—Ç–∫–∞—Ç –∫ –∫–æ–º–º–∏—Ç—É: \$(echo \$PREVIOUS_COMMIT | cut -c1-7)"

            # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∫–æ–¥ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
            git fetch origin || {
              echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ git fetch"
              exit 1
            }
            git checkout \$PREVIOUS_COMMIT || {
              echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ –∫ –∫–æ–º–º–∏—Ç—É \$PREVIOUS_COMMIT"
              exit 1
            }
            echo "‚úÖ –ö–æ–¥ –æ—Ç–∫–∞—á–µ–Ω –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏"

            # –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–ê–Ø –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ —Å–µ—Ç–µ–π
            echo "üõë –ì–ª—É–±–æ–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ Docker..."
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–≤–∫–ª—é—á–∞—è —Å–∫—Ä—ã—Ç—ã–µ)
            echo "  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            docker stop $(docker ps -aq) 2>/dev/null || echo "  –ù–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
            
            # –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "  –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            docker rm -f $(docker ps -aq) 2>/dev/null || echo "  –ù–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è"
            
            # –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–µ—Ç–∏ (–∫—Ä–æ–º–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö)
            echo "  –û—á–∏—Å—Ç–∫–∞ —Å–µ—Ç–µ–π..."
            docker network prune -f || true
            
            # Docker compose down –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ compose-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            echo "  Docker compose down..."
            docker compose down --remove-orphans 2>/dev/null || echo "  Compose –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω"
            
            # –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã Docker
            echo "  –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ Docker system..."
            docker system prune -a -f --volumes || echo "  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å system prune"
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ - —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø–æ –∏–º–µ–Ω–∞–º
            echo "üßπ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–æ –∏–º–µ–Ω–∞–º..."
            for name in public-redis public-backend public-frontend public-admin-frontend public-redis-commander; do
              echo "  –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: $name"
              # –£–¥–∞–ª—è–µ–º –ø–æ –∏–º–µ–Ω–∏
              docker rm -f "$name" 2>/dev/null || true
              # –£–¥–∞–ª—è–µ–º –ø–æ ID –µ—Å–ª–∏ –∏–º—è –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ
              CONTAINER_ID=$(docker ps -aq --filter "name=^${name}$" 2>/dev/null)
              if [ -n "$CONTAINER_ID" ]; then
                echo "    –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ ID: $CONTAINER_ID"
                docker rm -f "$CONTAINER_ID" 2>/dev/null || true
              fi
            done
            
            # –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å "public" –≤ –∏–º–µ–Ω–∏
            echo "  –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å 'public' –≤ –∏–º–µ–Ω–∏..."
            docker ps -a --format "{{.ID}} {{.Names}}" 2>/dev/null | grep -E "public" | awk '{print $1}' | while read -r id; do
              if [ -n "$id" ]; then
                echo "    –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø–æ ID: $id"
                docker rm -f "$id" 2>/dev/null || true
              fi
            done || true
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É–¥–∞–ª–µ–Ω—ã
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏..."
            echo "  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:"
            docker ps -a || echo "  –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
            echo "  –°–µ—Ç–∏:"
            docker network ls || echo "  –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–µ—Ç–µ–π"

            # –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê Docker –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–æ–π
            echo "üóëÔ∏è  –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê Docker –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–æ–π..."
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            docker compose down --remove-orphans 2>/dev/null || true
            
            # –£–¥–∞–ª—è–µ–º –≤—Å–µ –æ–±—Ä–∞–∑—ã –ø—Ä–æ–µ–∫—Ç–∞ —á–µ—Ä–µ–∑ docker images | grep
            echo "  –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –æ–±—Ä–∞–∑–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ —á–µ—Ä–µ–∑ grep..."
            docker images | grep "public-" | awk '{print $3}' | xargs -r docker rmi -f 2>/dev/null || true
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º docker compose down —Å —É–¥–∞–ª–µ–Ω–∏–µ–º –≤—Å–µ—Ö –æ–±—Ä–∞–∑–æ–≤
            echo "  Docker compose down --rmi all..."
            docker compose down --rmi all --volumes --remove-orphans 2>/dev/null || true
            
            # –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–∑—ã —á–µ—Ä–µ–∑ docker images –∏ xargs (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ)
            echo "  –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –æ–±—Ä–∞–∑–æ–≤ —Å 'public' —á–µ—Ä–µ–∑ docker images..."
            docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "public-" | xargs -r docker rmi -f 2>/dev/null || true
            docker images --format "{{.ID}} {{.Repository}}" | grep -E "public" | awk '{print $1}' | xargs -r docker rmi -f 2>/dev/null || true
            
            # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏–º–µ–Ω–∞–º
            for image in public-backend public-frontend public-admin-frontend; do
              echo "  –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–∞: $image"
              # –ü—Ä–æ–±—É–µ–º —É–¥–∞–ª–∏—Ç—å –ø–æ –ø–æ–ª–Ω–æ–º—É –∏–º–µ–Ω–∏ —Å —Ç–µ–≥–æ–º
              docker rmi -f "${image}:latest" 2>/dev/null || true
              # –ü—Ä–æ–±—É–µ–º —É–¥–∞–ª–∏—Ç—å –±–µ–∑ —Ç–µ–≥–∞
              docker rmi -f "$image" 2>/dev/null || true
              # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∏ —É–¥–∞–ª–∏—Ç—å –ø–æ ID (–≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã)
              docker images --format "{{.ID}} {{.Repository}}" | grep " ${image}$" | awk '{print $1}' | xargs -r docker rmi -f 2>/dev/null || true
            done
            
            # –ü–û–õ–ù–ê–Ø –æ—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã Docker
            echo "  –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ Docker system (prune -a -f --volumes)..."
            docker system prune -a -f --volumes 2>/dev/null || echo "  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω—É—é –æ—á–∏—Å—Ç–∫—É"
            
            # –£–¥–∞–ª—è–µ–º dangling images
            echo "  –û—á–∏—Å—Ç–∫–∞ dangling images..."
            docker image prune -f || true
            
            # –û—á–∏—â–∞–µ–º build cache
            echo "  –û—á–∏—Å—Ç–∫–∞ build cache..."
            docker builder prune -f || true
            
            # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
            echo "  –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤..."
            REMAINING_IMAGES=$(docker images --format "{{.Repository}}" | grep -E "public-" | wc -l || echo "0")
            if [ -n "$REMAINING_IMAGES" ] && [ "$REMAINING_IMAGES" -gt 0 ] 2>/dev/null; then
              echo "  ‚ö†Ô∏è  –í—Å–µ –µ—â–µ –æ—Å—Ç–∞–ª–æ—Å—å $REMAINING_IMAGES –æ–±—Ä–∞–∑–æ–≤, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ..."
              # –ü—Ä–æ–±—É–µ–º —É–¥–∞–ª–∏—Ç—å —á–µ—Ä–µ–∑ docker image rm
              docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "public-" | xargs -r docker image rm -f 2>/dev/null || true
              # –ü—Ä–æ–±—É–µ–º —É–¥–∞–ª–∏—Ç—å —á–µ—Ä–µ–∑ ID
              docker images --format "{{.ID}} {{.Repository}}" | grep -E "public-" | awk '{print $1}' | xargs -r docker image rm -f 2>/dev/null || true
              # –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ docker images | grep
              docker images | grep "public-" | awk '{print $3}' | xargs -r docker rmi -f 2>/dev/null || true
            fi
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –æ–±—Ä–∞–∑—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            echo "  –°–ø–∏—Å–æ–∫ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –æ–±—Ä–∞–∑–æ–≤:"
            docker images | grep -E "public|REPOSITORY" || echo "  –ù–µ—Ç –æ–±—Ä–∞–∑–æ–≤ —Å 'public'"
            
            # –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑—ã –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
            echo "üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏..."
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–µ–≥ –¥–ª—è rollback
            export UNIQUE_TAG="rollback-\$(date +%Y%m%d-%H%M%S)"
            echo "üè∑Ô∏è  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ–≥ –¥–ª—è rollback: \$UNIQUE_TAG"
            
            # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤ –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π
            echo "  –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤ –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π..."
            docker images | grep -E "public-|REPOSITORY" || echo "  –ù–µ—Ç –æ–±—Ä–∞–∑–æ–≤ —Å 'public'"
            # –ï—Å–ª–∏ –æ–±—Ä–∞–∑—ã –≤—Å–µ –µ—â–µ –µ—Å—Ç—å, —É–¥–∞–ª—è–µ–º –∏—Ö –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
            docker images | grep "public-" | awk '{print $3}' | xargs -r docker rmi -f 2>/dev/null || true
            docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "public-" | xargs -r docker image rm -f 2>/dev/null || true
            
            # –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–ß–ò–°–¢–ö–ê: –£–¥–∞–ª—è–µ–º –≤—Å–µ –æ–±—Ä–∞–∑—ã —Å —Ç–µ–≥–æ–º latest
            echo "  üî• –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –æ–±—Ä–∞–∑–æ–≤ —Å —Ç–µ–≥–æ–º :latest..."
            docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "public-(backend|frontend|admin-frontend):latest" | xargs -r docker rmi -f 2>/dev/null || true
            docker images --format "{{.ID}} {{.Repository}}:{{.Tag}}" | grep -E "public-(backend|frontend|admin-frontend).*latest" | awk '{print $1}' | xargs -r docker rmi -f 2>/dev/null || true
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è rollback
            export DEPLOY_ID="rollback-\$(date +%Y%m%d-%H%M%S)"
            
            # –°–±–æ—Ä–∫–∞ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º —Ç–µ–≥–æ–º (–ø–µ—Ä–µ–¥–∞–µ–º UNIQUE_TAG –∏ DEPLOY_ID —è–≤–Ω–æ)
            echo "üî® –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤ —Å —Ç–µ–≥–æ–º: \$UNIQUE_TAG –∏ ID: \$DEPLOY_ID"
            COMPOSE_PROJECT_NAME=public UNIQUE_TAG="\$UNIQUE_TAG" DEPLOY_ID="\$DEPLOY_ID" docker compose build --no-cache --pull --progress=plain --force-rm || {
              echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–µ –æ–±—Ä–∞–∑–æ–≤"
              exit 1
            }

            # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
            echo "üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º..."
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–≤–∫–ª—é—á–∞—è —Å–∫—Ä—ã—Ç—ã–µ —á–µ—Ä–µ–∑ -aq)
            echo "  –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–≤–∫–ª—é—á–∞—è —Å–∫—Ä—ã—Ç—ã–µ)..."
            ALL_CONTAINERS=$(docker ps -aq 2>/dev/null || echo "")
            if [ -n "$ALL_CONTAINERS" ]; then
              echo "  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã:"
              docker ps -a
              echo "  –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
              echo "$ALL_CONTAINERS" | xargs -r docker rm -f 2>/dev/null || true
            fi
            
            # –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å "public" –≤ –∏–º–µ–Ω–∏ (–≤–∫–ª—é—á–∞—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ)
            echo "  –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å 'public' –≤ –∏–º–µ–Ω–∏..."
            docker ps -a --format "{{.ID}} {{.Names}} {{.Status}}" 2>/dev/null | grep -E "public" | while read -r line; do
              if [ -n "$line" ]; then
                CONTAINER_ID=$(echo "$line" | awk '{print $1}')
                CONTAINER_NAME=$(echo "$line" | awk '{print $2}')
                echo "    –£–¥–∞–ª–µ–Ω–∏–µ: $CONTAINER_NAME (ID: $CONTAINER_ID, Status: $(echo "$line" | awk '{for(i=3;i<=NF;i++) printf "%s ", $i; print ""}'))"
                docker rm -f "$CONTAINER_ID" 2>/dev/null || docker rm -f "$CONTAINER_NAME" 2>/dev/null || true
              fi
            done || true
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏–º–µ–Ω–∞–º –∏ ID
            for name in public-redis public-backend public-frontend public-admin-frontend public-redis-commander; do
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –∏–º–µ–Ω–∏
              if docker ps -a --format "{{.Names}}" 2>/dev/null | grep -q "^${name}$"; then
                echo "  ‚ö†Ô∏è  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä $name –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ..."
                docker rm -f "$name" 2>/dev/null || true
              fi
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ ID
              CONTAINER_ID=$(docker ps -aq --filter "name=^${name}$" 2>/dev/null)
              if [ -n "$CONTAINER_ID" ]; then
                echo "    –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ ID: $CONTAINER_ID"
                docker rm -f "$CONTAINER_ID" 2>/dev/null || true
              fi
            done
            
            # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤—Å–µ –µ—â–µ –µ—Å—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º system prune
            REMAINING=$(docker ps -aq 2>/dev/null | wc -l)
            if [ "$REMAINING" -gt 0 ]; then
              echo "  ‚ö†Ô∏è  –í—Å–µ –µ—â–µ –æ—Å—Ç–∞–ª–æ—Å—å $REMAINING –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è system prune..."
              docker system prune -af --volumes 2>/dev/null || true
            fi
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ docker-compose.yml..."
            echo "=== –°–æ–¥–µ—Ä–∂–∏–º–æ–µ docker-compose.yml (—Å–µ–∫—Ü–∏—è redis) ==="
            grep -A 15 "^  redis:" docker-compose.yml || echo "–°–µ–∫—Ü–∏—è redis –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            
            # –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –ö–û–ù–¢–ï–ô–ù–ï–†–û–í –ü–ï–†–ï–î –ó–ê–ü–£–°–ö–û–ú
            echo "üßπ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –í–°–ï–• —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º rollback..."
            
            # –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ docker compose
            docker compose down --remove-orphans 2>/dev/null || true
            
            # –£–¥–∞–ª—è–µ–º –∫–∞–∂–¥—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏
            for container_name in public-frontend public-backend public-admin-frontend public-redis public-redis-commander; do
              echo "  –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: $container_name"
              docker rm -f "$container_name" 2>/dev/null || true
              # –¢–∞–∫–∂–µ —É–¥–∞–ª—è–µ–º –ø–æ ID –µ—Å–ª–∏ –∏–º—è –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ
              CONTAINER_ID=$(docker ps -aq --filter "name=^${container_name}$" 2>/dev/null || echo "")
              if [ -n "$CONTAINER_ID" ]; then
                echo "    –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ ID: $CONTAINER_ID"
                docker rm -f "$CONTAINER_ID" 2>/dev/null || true
              fi
            done
            
            # –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å "public" –≤ –∏–º–µ–Ω–∏
            docker ps -a --format "{{.ID}} {{.Names}}" 2>/dev/null | grep -E "public" | awk '{print $1}' | xargs -r docker rm -f 2>/dev/null || true
            
            # –£–¥–∞–ª—è–µ–º —Å–µ—Ç—å –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∞—Å—å
            docker network rm public_public-network 2>/dev/null || true
            
            echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            # –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –≤–º–µ—Å—Ç–µ (Docker Compose —Å–∞–º —Ä–∞–∑–±–µ—Ä–µ—Ç—Å—è —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏)
            echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏..."
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ Redis –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–¥–∞–ª–µ–Ω
            echo "  üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ Redis –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
            if docker ps -a --format "{{.Names}}" | grep -q "^public-redis$"; then
              echo "  ‚ö†Ô∏è  Redis –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ..."
              docker stop public-redis 2>/dev/null || true
              docker rm -f public-redis 2>/dev/null || true
              # –¢–∞–∫–∂–µ —É–¥–∞–ª—è–µ–º –ø–æ ID
              REDIS_ID=$(docker ps -aq --filter "name=^public-redis$" 2>/dev/null || echo "")
              if [ -n "$REDIS_ID" ]; then
                echo "    –£–¥–∞–ª–µ–Ω–∏–µ Redis –ø–æ ID: $REDIS_ID"
                docker rm -f "$REDIS_ID" 2>/dev/null || true
              fi
            fi
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –≤–º–µ—Å—Ç–µ (–ø–µ—Ä–µ–¥–∞–µ–º UNIQUE_TAG –∏ DEPLOY_ID)
            COMPOSE_PROJECT_NAME=public UNIQUE_TAG="\$UNIQUE_TAG" DEPLOY_ID="\$DEPLOY_ID" docker compose up -d --force-recreate --remove-orphans || {
              echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
              echo "üìã –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
              docker ps -a
              echo "üìã –°—Ç–∞—Ç—É—Å compose:"
              docker compose ps
              echo "üìã –õ–æ–≥–∏ Redis (–µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—É—â–µ—Å—Ç–≤—É–µ—Ç):"
              docker logs public-redis 2>&1 || echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä public-redis –Ω–µ –Ω–∞–π–¥–µ–Ω"
              echo "üìã –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ Redis –≤—Ä—É—á–Ω—É—é –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:"
              docker run -d --name test-redis-diagnostic redis:7-alpine redis-server --appendonly yes || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π Redis"
              sleep 3
              docker logs test-redis-diagnostic 2>&1 || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ Redis"
              docker stop test-redis-diagnostic 2>/dev/null || true
              docker rm test-redis-diagnostic 2>/dev/null || true
              echo "üìã –í—Å–µ –ª–æ–≥–∏:"
              docker compose logs
              exit 1
            }
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞
            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (5 —Å–µ–∫—É–Ω–¥)..."
            sleep 5
            echo "üìã –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞:"
            docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "NAMES|public" || docker ps -a
            echo "üìã –õ–æ–≥–∏ Redis –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞:"
            docker logs public-redis 2>&1 || echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä public-redis –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω"

            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (60 —Å–µ–∫—É–Ω–¥)..."
            sleep 60

            echo "‚úÖ –û—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω"
          EOF

      - name: –û—Ç–ø—Ä–∞–≤–∫–∞ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è - –û—à–∏–±–∫–∞ –¥–µ–ø–ª–æ—è —Å –æ—Ç–∫–∞—Ç–æ–º
        # Temporarily disabled
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT || 22 }}
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B)

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω –æ—Ç–∫–∞—Ç (–ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ –Ω–∞ VPS)
          ROLLBACK_STATUS="üîÑ –û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="‚ùå –î–µ–ø–ª–æ–π –Ω–µ —É–¥–∞–ª—Å—è%0A%0Aüì¶ –ö–æ–º–º–∏—Ç: ${COMMIT_SHA}%0Aüìù –°–æ–æ–±—â–µ–Ω–∏–µ: ${COMMIT_MSG}%0Aüåê VPS: ${VPS_HOST}%0A%0A${ROLLBACK_STATUS}" \
            -d parse_mode="HTML" || true

      - name: Deployment Summary
        if: success()
        run: |
          echo "## ‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üöÄ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Backend: http://${{ secrets.VPS_HOST }}:${{ secrets.BACKEND_PORT || '8000' }}" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Frontend: http://${{ secrets.VPS_HOST }}:${{ secrets.FRONTEND_PORT || '3000' }}" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Admin Frontend: http://${{ secrets.VPS_HOST }}:${{ secrets.ADMIN_FRONTEND_PORT || '3001' }}" >> $GITHUB_STEP_SUMMARY

      - name: Deployment Failed Summary
        if: failure()
        run: |
          echo "## ‚ùå –î–µ–ø–ª–æ–π –Ω–µ —É–¥–∞–ª—Å—è" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –≤—ã—è—Å–Ω–µ–Ω–∏—è –ø—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–∫–∏." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω (–µ—Å–ª–∏ –±—ã–ª–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∞—è –≤–µ—Ä—Å–∏—è)." >> $GITHUB_STEP_SUMMARY
