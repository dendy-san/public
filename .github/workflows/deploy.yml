name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.VPS_SSH_PORT || 22 }} ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT || 22 }}
          VPS_PROJECT_PATH: ${{ secrets.VPS_PROJECT_PATH || '~/public' }}
          BACKEND_PORT: ${{ secrets.BACKEND_PORT || 8000 }}
          FRONTEND_PORT: ${{ secrets.FRONTEND_PORT || 3000 }}
          ADMIN_FRONTEND_PORT: ${{ secrets.ADMIN_FRONTEND_PORT || 3001 }}
        run: |
          ssh -i ~/.ssh/deploy_key -p $VPS_SSH_PORT $VPS_USER@$VPS_HOST << 'ENDSSH'
            set -e
            set +H  # –û—Ç–∫–ª—é—á–∞–µ–º history expansion –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å !
            
            PROJECT_PATH="${{ secrets.VPS_PROJECT_PATH || '~/public' }}"
            PROJECT_PATH=$(eval echo $PROJECT_PATH)
            
            echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è –Ω–∞ VPS..."
            echo "üìÅ –ü—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É: $PROJECT_PATH"
            
            # –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd "$PROJECT_PATH" || { echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $PROJECT_PATH"; exit 1; }
            
            # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –¥–ª—è rollback
            CURRENT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "none")
            echo "$CURRENT_COMMIT" > .previous_version
            echo "üíæ –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: $CURRENT_COMMIT"
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
            echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ Git..."
            git fetch origin
            git pull origin main || { echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ git pull"; exit 1; }
            
            # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            docker compose down || echo "‚ö†Ô∏è –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –±—ã–ª–∏ –∑–∞–ø—É—â–µ–Ω—ã"
            
            # –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤
            echo "üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤..."
            DEPLOY_ID=$(date +%s)
            export DEPLOY_ID
            docker compose build --no-cache || { echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ –æ–±—Ä–∞–∑–æ–≤"; exit 1; }
            
            # –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            docker compose up -d || { echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"; exit 1; }
            
            # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (30 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏)..."
            sleep 30
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è Redis
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è Redis..."
            if docker compose ps redis 2>/dev/null | grep -q "healthy"; then
              echo "‚úÖ Redis –∑–¥–æ—Ä–æ–≤"
            else
              echo "‚ö†Ô∏è Redis –Ω–µ –∑–¥–æ—Ä–æ–≤, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º..."
            fi
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è Backend
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è Backend..."
            MAX_RETRIES=10
            RETRY_COUNT=0
            BACKEND_HEALTHY=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if docker compose exec -T backend curl -f http://localhost:8000/health > /dev/null 2>&1; then
                echo "‚úÖ Backend –∑–¥–æ—Ä–æ–≤"
                BACKEND_HEALTHY=true
                break
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ Backend... ($RETRY_COUNT/$MAX_RETRIES)"
              sleep 5
            done
            
            if [ "$BACKEND_HEALTHY" = "false" ]; then
              echo "‚ùå Backend –Ω–µ –ø—Ä–æ—à–µ–ª health check"
              echo "üìã –õ–æ–≥–∏ Backend:"
              docker compose logs --tail=50 backend
              exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker compose ps
            
            # –û—á–∏—Å—Ç–∫–∞ Docker
            echo "üßπ –û—á–∏—Å—Ç–∫–∞ Docker..."
            docker system prune -af --volumes || echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ Docker"
            
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
          ENDSSH

      - name: Send Telegram notification (success)
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ] && [ "$TELEGRAM_BOT_TOKEN" != "none" ] && [ "$TELEGRAM_CHAT_ID" != "none" ] && [ "$TELEGRAM_BOT_TOKEN" != "" ] && [ "$TELEGRAM_CHAT_ID" != "" ]; then
            MESSAGE="‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!%0A%0A–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}%0A–í–µ—Ç–∫–∞: ${{ github.ref_name }}%0A–ö–æ–º–º–∏—Ç: ${{ github.sha }}%0A–ê–≤—Ç–æ—Ä: ${{ github.actor }}"
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${MESSAGE}" \
              -d "parse_mode=HTML" > /dev/null || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram"
          else
            echo "‚ÑπÔ∏è Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–æ–ø—É—â–µ–Ω—ã (–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã)"
          fi

      - name: Send Telegram notification (failure)
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ] && [ "$TELEGRAM_BOT_TOKEN" != "none" ] && [ "$TELEGRAM_CHAT_ID" != "none" ] && [ "$TELEGRAM_BOT_TOKEN" != "" ] && [ "$TELEGRAM_CHAT_ID" != "" ]; then
            MESSAGE="‚ùå –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π!%0A%0A–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}%0A–í–µ—Ç–∫–∞: ${{ github.ref_name }}%0A–ö–æ–º–º–∏—Ç: ${{ github.sha }}%0A–ê–≤—Ç–æ—Ä: ${{ github.actor }}%0A%0A–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ GitHub Actions."
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${MESSAGE}" \
              -d "parse_mode=HTML" > /dev/null || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram"
          else
            echo "‚ÑπÔ∏è Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–æ–ø—É—â–µ–Ω—ã (–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã)"
          fi
