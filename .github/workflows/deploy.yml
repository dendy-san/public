name: Deploy to VPS

# –¢—Ä–∏–≥–≥–µ—Ä—ã: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –ø—Ä–∏ push –≤ main –∏ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4

      # –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –∞–≥–µ–Ω—Ç–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ VPS
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      # –®–∞–≥ 3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ VPS –≤ known_hosts –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      - name: Add VPS to known hosts
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
        run: |
          VPS_SSH_PORT=${VPS_SSH_PORT:-22}
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
          if [ -z "$VPS_HOST" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: VPS_HOST –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          
          # –£–¥–∞–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
          VPS_HOST=$(echo "$VPS_HOST" | tr -d '[:space:]')
          
          mkdir -p ~/.ssh
          ssh-keyscan -p "$VPS_SSH_PORT" -H "$VPS_HOST" >> ~/.ssh/known_hosts

      # –®–∞–≥ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      - name: Test SSH connection
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
        run: |
          VPS_SSH_PORT=${VPS_SSH_PORT:-22}
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
          if [ -z "$VPS_HOST" ] || [ -z "$VPS_USER" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: VPS_HOST –∏–ª–∏ VPS_USER –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
            exit 1
          fi
          
          # –£–¥–∞–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
          VPS_HOST=$(echo "$VPS_HOST" | tr -d '[:space:]')
          VPS_USER=$(echo "$VPS_USER" | tr -d '[:space:]')
          
          ssh -p "$VPS_SSH_PORT" \
              "$VPS_USER@$VPS_HOST" \
              "echo ‚úÖ SSH connection successful"

      # –®–∞–≥ 5: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–º–º–∏—Ç–∞ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ rollback
      - name: Save current commit for rollback
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
          VPS_PROJECT_PATH: ${{ secrets.VPS_PROJECT_PATH }}
        run: |
          VPS_SSH_PORT=${VPS_SSH_PORT:-22}
          VPS_PROJECT_PATH=${VPS_PROJECT_PATH:-~/public}
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
          if [ -z "$VPS_HOST" ] || [ -z "$VPS_USER" ]; then
            echo "‚ö†Ô∏è VPS_HOST –∏–ª–∏ VPS_USER –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏"
            exit 0
          fi
          
          # –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ (–±–µ–∑ –ø–æ–∫–∞–∑–∞ –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
          echo "üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–º–º–∏—Ç–∞ –¥–ª—è rollback..."
          echo "üìç –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫: $VPS_USER@$VPS_HOST:$VPS_SSH_PORT"
          
          # –£–¥–∞–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
          VPS_HOST=$(echo "$VPS_HOST" | tr -d '[:space:]')
          VPS_USER=$(echo "$VPS_USER" | tr -d '[:space:]')
          
          ssh -p "$VPS_SSH_PORT" "$VPS_USER@$VPS_HOST" \
            "cd $VPS_PROJECT_PATH && git rev-parse HEAD > .previous_version 2>/dev/null || echo '–ù–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏'" || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–µ—Ä—Å–∏—é (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)"

      # –®–∞–≥ 6: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–∞—á–∞–ª–µ –¥–µ–ø–ª–æ—è (Telegram, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - name: Send deployment start notification
        continue-on-error: true
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            COMMIT_MSG=$(git log -1 --pretty=%B)
            COMMIT_AUTHOR=$(git log -1 --pretty=%an)
            COMMIT_SHA=$(git rev-parse --short HEAD)
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d "chat_id=$TELEGRAM_CHAT_ID" \
              -d "text=üöÄ –ù–∞—á–∞—Ç –¥–µ–ø–ª–æ–π%0Aüì¶ –ö–æ–º–º–∏—Ç: $COMMIT_SHA%0Aüë§ –ê–≤—Ç–æ—Ä: $COMMIT_AUTHOR%0Aüí¨ –°–æ–æ–±—â–µ–Ω–∏–µ: $COMMIT_MSG" \
              -d "parse_mode=HTML" || true
          fi

      # –®–∞–≥ 7: –û—Å–Ω–æ–≤–Ω–æ–π –¥–µ–ø–ª–æ–π –Ω–∞ VPS
      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
          VPS_PROJECT_PATH: ${{ secrets.VPS_PROJECT_PATH }}
        run: |
          VPS_SSH_PORT=${VPS_SSH_PORT:-22}
          VPS_PROJECT_PATH=${VPS_PROJECT_PATH:-~/public}
          echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è –Ω–∞ VPS..."
          echo "üìç –¶–µ–ª–µ–≤–æ–π —Å–µ—Ä–≤–µ—Ä: $VPS_USER@$VPS_HOST:$VPS_SSH_PORT"
          echo "üìÅ –ü—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É: $VPS_PROJECT_PATH"
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤
          if [ -z "$VPS_HOST" ] || [ -z "$VPS_USER" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: VPS_HOST –∏–ª–∏ VPS_USER –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
            exit 1
          fi
          
          # –£–¥–∞–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
          VPS_HOST=$(echo "$VPS_HOST" | tr -d '[:space:]')
          VPS_USER=$(echo "$VPS_USER" | tr -d '[:space:]')
          
          # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–ø–ª–æ—è —á–µ—Ä–µ–∑ SSH (–ø–µ—Ä–µ–¥–∞—á–∞ –∫–æ–º–∞–Ω–¥—ã –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç)
          ssh -p "$VPS_SSH_PORT" "$VPS_USER@$VPS_HOST" "cd $VPS_PROJECT_PATH && \
            echo 'üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è...' && \
            git fetch origin main && \
            git reset --hard origin/main && \
            echo 'üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...' && \
            docker compose down || true && \
            echo 'üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤...' && \
            docker compose build --no-cache && \
            echo 'üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...' && \
            docker compose up -d && \
            echo '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (60 —Å–µ–∫—É–Ω–¥)...' && \
            sleep 60 && \
            echo '‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω, –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–æ–≤...'"

      # –®–∞–≥ 8: Health check –¥–ª—è Backend
      - name: Health check - Backend
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          BACKEND_PORT: ${{ secrets.BACKEND_PORT }}
        run: |
          BACKEND_PORT=${BACKEND_PORT:-8000}
          echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è Backend..."
          MAX_RETRIES=30
          RETRY_INTERVAL=2
          
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -f -s "http://$VPS_HOST:$BACKEND_PORT/health" > /dev/null 2>&1; then
              echo "‚úÖ Backend –∑–¥–æ—Ä–æ–≤ (–ø–æ–ø—ã—Ç–∫–∞ $i/$MAX_RETRIES)"
              exit 0
            fi
            echo "‚è≥ Backend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, –ø–æ–ø—ã—Ç–∫–∞ $i/$MAX_RETRIES..."
            sleep $RETRY_INTERVAL
          done
          
          echo "‚ùå Backend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ $MAX_RETRIES –ø–æ–ø—ã—Ç–æ–∫"
          exit 1

      # –®–∞–≥ 9: Health check –¥–ª—è Frontend
      - name: Health check - Frontend
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          FRONTEND_PORT: ${{ secrets.FRONTEND_PORT }}
        run: |
          FRONTEND_PORT=${FRONTEND_PORT:-3000}
          echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è Frontend..."
          MAX_RETRIES=30
          RETRY_INTERVAL=2
          
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -f -s "http://$VPS_HOST:$FRONTEND_PORT" > /dev/null 2>&1; then
              echo "‚úÖ Frontend –∑–¥–æ—Ä–æ–≤ (–ø–æ–ø—ã—Ç–∫–∞ $i/$MAX_RETRIES)"
              exit 0
            fi
            echo "‚è≥ Frontend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, –ø–æ–ø—ã—Ç–∫–∞ $i/$MAX_RETRIES..."
            sleep $RETRY_INTERVAL
          done
          
          echo "‚ùå Frontend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ $MAX_RETRIES –ø–æ–ø—ã—Ç–æ–∫"
          exit 1

      # –®–∞–≥ 10: Health check –¥–ª—è Admin Frontend
      - name: Health check - Admin Frontend
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          ADMIN_FRONTEND_PORT: ${{ secrets.ADMIN_FRONTEND_PORT }}
        run: |
          ADMIN_FRONTEND_PORT=${ADMIN_FRONTEND_PORT:-3001}
          echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è Admin Frontend..."
          MAX_RETRIES=30
          RETRY_INTERVAL=2
          
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -f -s "http://$VPS_HOST:$ADMIN_FRONTEND_PORT" > /dev/null 2>&1; then
              echo "‚úÖ Admin Frontend –∑–¥–æ—Ä–æ–≤ (–ø–æ–ø—ã—Ç–∫–∞ $i/$MAX_RETRIES)"
              exit 0
            fi
            echo "‚è≥ Admin Frontend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, –ø–æ–ø—ã—Ç–∫–∞ $i/$MAX_RETRIES..."
            sleep $RETRY_INTERVAL
          done
          
          echo "‚ùå Admin Frontend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ $MAX_RETRIES –ø–æ–ø—ã—Ç–æ–∫"
          exit 1

      # –®–∞–≥ 11: –û—á–∏—Å—Ç–∫–∞ Docker (—É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—Ä–∞–∑–æ–≤ –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤)
      - name: Docker cleanup
        if: success()
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
          VPS_PROJECT_PATH: ${{ secrets.VPS_PROJECT_PATH }}
        run: |
          VPS_SSH_PORT=${VPS_SSH_PORT:-22}
          # –£–¥–∞–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
          VPS_HOST=$(echo "$VPS_HOST" | tr -d '[:space:]')
          VPS_USER=$(echo "$VPS_USER" | tr -d '[:space:]')
          
          echo "üßπ –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö Docker —Ä–µ—Å—É—Ä—Å–æ–≤..."
          ssh -p "$VPS_SSH_PORT" "$VPS_USER@$VPS_HOST" \
            "docker system prune -af --volumes" || echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ Docker (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)"

      # –®–∞–≥ 12: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—à–Ω–æ–º –¥–µ–ø–ª–æ–µ (Telegram, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - name: Send deployment success notification
        if: success()
        continue-on-error: true
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            COMMIT_MSG=$(git log -1 --pretty=%B)
            COMMIT_AUTHOR=$(git log -1 --pretty=%an)
            COMMIT_SHA=$(git rev-parse --short HEAD)
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d "chat_id=$TELEGRAM_CHAT_ID" \
              -d "text=‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω%0Aüì¶ –ö–æ–º–º–∏—Ç: $COMMIT_SHA%0Aüë§ –ê–≤—Ç–æ—Ä: $COMMIT_AUTHOR%0Aüí¨ –°–æ–æ–±—â–µ–Ω–∏–µ: $COMMIT_MSG" \
              -d "parse_mode=HTML" || true
          fi

      # –®–∞–≥ 13: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ
      - name: Rollback on failure
        if: failure()
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
          VPS_PROJECT_PATH: ${{ secrets.VPS_PROJECT_PATH }}
        run: |
          VPS_SSH_PORT=${VPS_SSH_PORT:-22}
          VPS_PROJECT_PATH=${VPS_PROJECT_PATH:-~/public}
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
          if [ -z "$VPS_HOST" ] || [ -z "$VPS_USER" ]; then
            echo "‚ö†Ô∏è VPS_HOST –∏–ª–∏ VPS_USER –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, rollback –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω"
            exit 0
          fi
          
          # –£–¥–∞–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
          VPS_HOST=$(echo "$VPS_HOST" | tr -d '[:space:]')
          VPS_USER=$(echo "$VPS_USER" | tr -d '[:space:]')
          
          echo "üîÑ –ù–∞—á–∞–ª–æ rollback –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏..."
          
          ssh -p "$VPS_SSH_PORT" "$VPS_USER@$VPS_HOST" "cd $VPS_PROJECT_PATH && \
            if [ -f .previous_version ]; then \
              PREVIOUS_COMMIT=\$(cat .previous_version) && \
              echo 'üì¶ –û—Ç–∫–∞—Ç –∫ –∫–æ–º–º–∏—Ç—É:' \$PREVIOUS_COMMIT && \
              git fetch origin main && \
              git reset --hard \$PREVIOUS_COMMIT || git reset --hard origin/main~1 || true && \
              echo 'üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...' && \
              docker compose down || true && \
              echo 'üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤...' && \
              docker compose build --no-cache && \
              echo 'üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏...' && \
              docker compose up -d && \
              echo '‚úÖ Rollback –∑–∞–≤–µ—Ä—à–µ–Ω'; \
            else \
              echo '‚ö†Ô∏è –ü—Ä–µ–¥—ã–¥—É—â–∞—è –≤–µ—Ä—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, rollback –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω'; \
            fi"

      # –®–∞–≥ 14: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ –¥–µ–ø–ª–æ—è (Telegram, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - name: Send deployment failure notification
        if: failure()
        continue-on-error: true
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            COMMIT_MSG=$(git log -1 --pretty=%B)
            COMMIT_AUTHOR=$(git log -1 --pretty=%an)
            COMMIT_SHA=$(git rev-parse --short HEAD)
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d "chat_id=$TELEGRAM_CHAT_ID" \
              -d "text=‚ùå –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π%0Aüì¶ –ö–æ–º–º–∏—Ç: $COMMIT_SHA%0Aüë§ –ê–≤—Ç–æ—Ä: $COMMIT_AUTHOR%0Aüí¨ –°–æ–æ–±—â–µ–Ω–∏–µ: $COMMIT_MSG%0A%0AüîÑ –í—ã–ø–æ–ª–Ω–µ–Ω rollback –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏" \
              -d "parse_mode=HTML" || true
          fi
