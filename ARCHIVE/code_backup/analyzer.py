from typing import Any, Dict, List, Optional, Tuple
import re
import asyncio
import json

import httpx
from bs4 import BeautifulSoup
from starlette.concurrency import run_in_threadpool

from app.services.llm_client import LLMClient
try:
    from app.services.cache import cache_service
    CACHE_AVAILABLE = True
except ImportError:
    CACHE_AVAILABLE = False


class SiteAnalyzer:
    def __init__(self, llm_client: LLMClient) -> None:
        self.llm = llm_client

    async def fetch_html(self, url: str) -> str:
        timeout = httpx.Timeout(20.0)
        async with httpx.AsyncClient(timeout=timeout, follow_redirects=True) as client:
            resp = await client.get(url)
            resp.raise_for_status()
            return resp.text

    def html_to_text(self, html: str) -> Tuple[str, bool, Optional[str]]:
        soup = BeautifulSoup(html, "html.parser")
        for tag in soup(["script", "style", "noscript"]):
            tag.decompose()
        text = soup.get_text(separator="\n")
        lines = [line.strip() for line in text.splitlines()]
        chunks = [chunk for line in lines for chunk in line.split("  ")]
        cleaned = "\n".join(chunk for chunk in chunks if chunk)

        # –£–º–Ω–æ–µ —É—Å–µ—á–µ–Ω–∏–µ - –µ—Å–ª–∏ —Å–∞–π—Ç —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π, –±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–µ 40 000 —Å–∏–º–≤–æ–ª–æ–≤
        max_len = 40000
        truncated = False
        truncation_message: Optional[str] = None
        if len(cleaned) > max_len:
            cleaned = cleaned[:max_len] + "..."
            truncated = True
            truncation_message = "–û–±—ä–µ–º —Å–∞–π—Ç–∞ —Å–ª–∏—à–∫–æ–º –≤–µ–ª–∏–∫. –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤–∑—è—Ç–æ 40 000 —Å–∏–º–≤–æ–ª–æ–≤ —Ç–µ–∫—Å—Ç–∞."

        return cleaned, truncated, truncation_message

    async def get_steps(self, cleaned_text: str) -> List[str]:
        system_prompt = (
            "–¢—ã –∞–≤—Ç–æ—Ä –ø–æ—Å—Ç–æ–≤ –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö. –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –æ—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ù–∏–∫–∞–∫–æ–≥–æ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞. –í—Å–µ –∫–ª—é—á–∏, –∑–Ω–∞—á–µ–Ω–∏—è, –æ–ø–∏—Å–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ò–ì–ù–û–†–ò–†–£–ô —è–∑—ã–∫ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –æ—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º. –í–æ—Ç —Ç–µ–∫—Å—Ç —Å–∞–π—Ç–∞: "
            f"{cleaned_text}\n"
            "–≤–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ json-–æ–±—ä–µ–∫—Ç –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞. –ö–ª—é—á 'steps' ‚Äî –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫ –∏–∑ 5-6 —à–∞–≥–æ–≤ (–ø—Ä–æ–º–ø—Ç–æ–≤), –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞ –∏ –≤—ã—è–≤–ª–µ–Ω–∏—è –∏–¥–µ–π –¥–ª—è –ø–æ—Å—Ç–æ–≤ –≤ —Å–æ—Ü—Å–µ—Ç–∏. –í—Å–µ –æ—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ù–∏–∫–∞–∫–æ–≥–æ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.\n–≤–µ—Ä–Ω–∏ json"
        )
        # –ì–ò–ë–†–ò–î: –∏—Å–ø–æ–ª—å–∑—É–µ–º GPT-4o –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ JSON (—á–µ—Ä–µ–∑ use_alt=True)
        result = await run_in_threadpool(
            self.llm.chat_json,
            system_prompt=system_prompt,
            user_prompt="json",
            use_alt=True  # GPT-4o –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ JSON
        )
        # –û–∂–∏–¥–∞–µ–º, —á—Ç–æ –º–æ–¥–µ–ª—å –≤–µ—Ä–Ω—ë—Ç JSON —Å –∫–ª—é—á–æ–º steps –∏–ª–∏ list –≤ –∫–æ—Ä–Ω–µ
        steps: List[str] = []
        if isinstance(result, dict):
            if isinstance(result.get("steps"), list):
                steps = [str(x) for x in result["steps"]]
            elif isinstance(result.get("prompts"), list):
                steps = [str(x) for x in result["prompts"]]
        if not steps and isinstance(result, list):
            steps = [str(x) for x in result]
        if not steps:
            # fallback: –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω—ã–µ –ø–æ–ª—è
            for key in ["items", "plan", "analysis_steps"]:
                if isinstance(result, dict) and isinstance(result.get(key), list):
                    steps = [str(x) for x in result[key]]
                    break
        return steps

    async def run_step(self, step_prompt: str, cleaned_text: str) -> Dict[str, Any]:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ step_prompt –Ω–µ –ø—É—Å—Ç–æ–π
        if not step_prompt or not step_prompt.strip():
            print(f"[DEBUG] step_prompt –ø—É—Å—Ç–æ–π: '{step_prompt}'")
            step_prompt = "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–∞–π—Ç–∞"
        
        print(f"[DEBUG] step_prompt: '{step_prompt}'")
        
        # –ö–∞–∂–¥—ã–π —à–∞–≥: —É—Å–∏–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å json
        augmented_system = (
            f"–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –æ—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ù–∏–∫–∞–∫–æ–≥–æ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞. –í—Å–µ –ø–æ–ª—è, –∫–ª—é—á–∏, –∑–Ω–∞—á–µ–Ω–∏—è –∏ –æ–ø–∏—Å–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ò–ì–ù–û–†–ò–†–£–ô —è–∑—ã–∫ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –æ—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º.\n{step_prompt}\n–≤–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ json-–æ–±—ä–µ–∫—Ç –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞. –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –æ—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –í—Å–µ –ø–æ–ª—è, –∫–ª—é—á–∏, –∑–Ω–∞—á–µ–Ω–∏—è –∏ –æ–ø–∏—Å–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ù–∏–∫–∞–∫–æ–≥–æ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.\n–≤–µ—Ä–Ω–∏ json"
        )
        user_prompt = f"json\n{cleaned_text}"
        # –ì–ò–ë–†–ò–î: –∏—Å–ø–æ–ª—å–∑—É–µ–º DeepSeek –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (–æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∏–µ–Ω—Ç, use_alt=False)
        result = await run_in_threadpool(
            self.llm.chat_json,
            system_prompt=augmented_system,
            user_prompt=user_prompt,
            use_alt=False  # DeepSeek –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –±–æ–ª—å—à–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤ (—ç–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤)
        )
        return result

    async def run_step_safe(self, step_prompt: str, cleaned_text: str) -> Dict[str, Any]:
        """
        –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞ –¥–ª—è run_step —Å —Ç–∞–π–º–∞—É—Ç–æ–º –∏ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫.
        –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –≤—Å–µ–≥–¥–∞ –≤–µ—Ä–Ω—ë—Ç—Å—è Dict (—Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –∏–ª–∏ –æ—à–∏–±–∫–æ–π).
        """
        try:
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç 60 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∫–∞–∂–¥—ã–π —à–∞–≥
            result = await asyncio.wait_for(
                self.run_step(step_prompt, cleaned_text),
                timeout=60.0
            )
            return result
        except asyncio.TimeoutError:
            print(f"[WARNING] Step timeout (60s): {step_prompt[:50]}...")
            return {"error": "–ü—Ä–µ–≤—ã—à–µ–Ω —Ç–∞–π–º–∞—É—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (60 —Å–µ–∫)"}
        except Exception as exc:
            print(f"[ERROR] Step failed: {step_prompt[:50]}... | Error: {exc}")
            return {"error": str(exc)}

    async def finalize(self, intermediate_results: List[Dict[str, Any]], cleaned_text: str, style: str = "—É–±–µ–¥–∏—Ç–µ–ª—å–Ω–æ-–ø–æ–∑–∏—Ç–∏–≤–Ω–æ–º", occasion: str = "") -> Dict[str, Any]:
        # –î–µ—Ç–∞–ª—å–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è —Å—Ç–∏–ª–µ–π –¥–ª—è LLM
        style_guidelines = {
            "—É–±–µ–¥–∏—Ç–µ–ª—å–Ω–æ-–ø–æ–∑–∏—Ç–∏–≤–Ω–æ–º": "–ò—Å–ø–æ–ª—å–∑—É–π –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–µ —Å–ª–æ–≤–∞, –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏, –ø—Ä–∏–∑—ã–≤—ã –∫ –¥–µ–π—Å—Ç–≤–∏—é. –ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–π –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏. –¢–æ–Ω: –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π, –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π, —ç–Ω–µ—Ä–≥–∏—á–Ω—ã–π.",
            "–∏—Ä–æ–Ω–∏—á–Ω–æ–º": "–ò—Å–ø–æ–ª—å–∑—É–π –ª–µ–≥–∫—É—é –∏—Ä–æ–Ω–∏—é, –∏–≥—Ä—É —Å–ª–æ–≤, —é–º–æ—Ä. –ú–æ–∂–µ—à—å —Å–ª–µ–≥–∫–∞ –ø–æ–¥—à—É—á–∏–≤–∞—Ç—å –Ω–∞–¥ —Å—Ç–µ—Ä–µ–æ—Ç–∏–ø–∞–º–∏. –¢–æ–Ω: –æ—Å—Ç—Ä–æ—É–º–Ω—ã–π, —Å —é–º–æ—Ä–æ–º, –Ω–æ –Ω–µ –æ–±–∏–¥–Ω—ã–π.",
            "—Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–æ–º": "–ü–∏—à–∏ –∫–∞–∫ –≤ –¥—Ä—É–∂–µ—Å–∫–æ–π –±–µ—Å–µ–¥–µ, –∏—Å–ø–æ–ª—å–∑—É–π '—Ç—ã', —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ –æ–±–æ—Ä–æ—Ç—ã, —Å–ª–µ–Ω–≥. –ò–∑–±–µ–≥–∞–π –æ—Ñ–∏—Ü–∏–æ–∑–∞. –¢–æ–Ω: –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π, –±–ª–∏–∑–∫–∏–π.",
            "–ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω–æ–º": "–ó–∞–¥–∞–≤–∞–π –æ—Å—Ç—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã, –∏—Å–ø–æ–ª—å–∑—É–π —Å–º–µ–ª—ã–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, –±—Ä–æ—Å–∞–π –≤—ã–∑–æ–≤ —Å—Ç–µ—Ä–µ–æ—Ç–∏–ø–∞–º. –ü—Ä–∏–≤–ª–µ–∫–∞–π –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–µ–æ–±—ã—á–Ω—ã–º–∏ –∑–∞—è–≤–ª–µ–Ω–∏—è–º–∏. –¢–æ–Ω: –¥–µ—Ä–∑–∫–∏–π, –≤—ã–∑—ã–≤–∞—é—â–∏–π, —Ü–µ–ø–ª—è—é—â–∏–π.",
            "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–º": "–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π —Ñ–∞–∫—Ç—ã, —Ü–∏—Ñ—Ä—ã, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ú–∏–Ω–∏–º—É–º —ç–º–æ—Ü–∏–π, –º–∞–∫—Å–∏–º—É–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –¢–æ–Ω: –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π, –æ–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π.",
            "–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ-–¥–µ–ª–æ–≤–æ–º": "–ò—Å–ø–æ–ª—å–∑—É–π –¥–µ–ª–æ–≤—É—é –ª–µ–∫—Å–∏–∫—É, —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–ª–æ–∂–µ–Ω–∏–µ. –ò–∑–±–µ–≥–∞–π —Å–ª–µ–Ω–≥–∞ –∏ —ç–º–æ–¥–∑–∏. –¢–æ–Ω: —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π, –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π.",
            "—Å—Ç–æ—Ä–∏—Ç–µ–ª–ª–∏–Ω–≥–∞": "–†–∞—Å—Å–∫–∞–∑—ã–≤–∞–π –∏—Å—Ç–æ—Ä–∏—é —Å –∑–∞–≤—è–∑–∫–æ–π, —Ä–∞–∑–≤–∏—Ç–∏–µ–º –∏ –∫—É–ª—å–º–∏–Ω–∞—Ü–∏–µ–π. –ò—Å–ø–æ–ª—å–∑—É–π –æ–±—Ä–∞–∑—ã, –º–µ—Ç–∞—Ñ–æ—Ä—ã, —Å–æ–∑–¥–∞–≤–∞–π –∞—Ç–º–æ—Å—Ñ–µ—Ä—É. –¢–æ–Ω: –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π, —É–≤–ª–µ–∫–∞—é—â–∏–π, –æ–±—Ä–∞–∑–Ω—ã–π.",
            "–ø—Ä–æ–¥–∞—é—â–µ–º": "–§–æ–∫—É—Å –Ω–∞ –≤—ã–≥–æ–¥–µ –∫–ª–∏–µ–Ω—Ç–∞, –ø—Ä–∏–∑—ã–≤—ã –∫ –¥–µ–π—Å—Ç–≤–∏—é (CTA), —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏. –ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–π —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –¢–æ–Ω: —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–π, –∞–∫—Ç–∏–≤–Ω—ã–π, —Å—Ç–∏–º—É–ª–∏—Ä—É—é—â–∏–π.",
            "–º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–º": "–ò—Å–ø–æ–ª—å–∑—É–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã —Ç–∞–º –≥–¥–µ —É–º–µ—Å—Ç–Ω–æ, —Å—Å—ã–ª–∞–π—Å—è –Ω–∞ –∑–¥–æ—Ä–æ–≤—å–µ –∏ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏–µ. –ë—É–¥—å —Ç–æ—á–Ω—ã–º –∏ –∫–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω—ã–º. –¢–æ–Ω: –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –∑–∞–±–æ—Ç–ª–∏–≤—ã–π, —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π."
        }
        
        style_instruction = style_guidelines.get(style, "–°–ª–µ–¥—É–π –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Å—Ç–∏–ª—é –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω–æ.")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –∏–Ω—Ñ–æ–ø–æ–≤–æ–¥—É, –µ—Å–ª–∏ –æ–Ω —É–∫–∞–∑–∞–Ω
        occasion_instruction = ""
        if occasion and occasion.strip():
            occasion_instruction = (
                f"\n\n–ò–ù–§–û–ü–û–í–û–î / –ö–û–ù–¢–ï–ö–°–¢ –ü–£–ë–õ–ò–ö–ê–¶–ò–ò: {occasion.strip()}\n"
                f"–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É—á—Ç–∏ —ç—Ç–æ—Ç –∏–Ω—Ñ–æ–ø–æ–≤–æ–¥ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Å—Ç–æ–≤! –ü–æ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–≤—è–∑–∞–Ω—ã —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –ø–æ–≤–æ–¥–æ–º –∏–ª–∏ —Å–æ–±—ã—Ç–∏–µ–º. "
                f"–ê–¥–∞–ø—Ç–∏—Ä—É–π —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ–¥ —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç, –¥–µ–ª–∞–π –∞–∫—Ü–µ–Ω—Ç—ã –Ω–∞ —Ç–æ–º, –∫–∞–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å —Å–∞–π—Ç–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –¥–∞–Ω–Ω—ã–º –ø–æ–≤–æ–¥–æ–º.\n"
            )
        
        system_prompt = (
            "–¢—ã —Ç–∞–ª–∞–Ω—Ç–ª–∏–≤—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä. –£ —Ç–µ–±—è –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Å–∞–π—Ç–∞: "
            f"{intermediate_results}. "
            f"–û–±—ä–µ–¥–∏–Ω–∏ –∏—Ö –∏ —Å–æ–∑–¥–∞–π —Ç—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–æ—Å—Ç–æ–≤ –¥–ª—è —Å–æ—Ü—Å–µ—Ç–∏ –≤ {style} —Å—Ç–∏–ª–µ. "
            f"{occasion_instruction}"
            f"\n\n–û–°–û–ë–ï–ù–ù–û–°–¢–ò {style.upper()} –°–¢–ò–õ–Ø: {style_instruction}\n\n"
            "–°–¢–†–û–ì–û —Å–ª–µ–¥—É–π —ç—Ç–æ–º—É —Å—Ç–∏–ª—é! –ö–∞–∂–¥—ã–π –ø–æ—Å—Ç –¥–æ–ª–∂–µ–Ω —è–≤–Ω–æ –æ—Ç—Ä–∞–∂–∞—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ —á–µ—Ä—Ç—ã –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—Ç–∏–ª—è. "
            "–≤–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ json-–æ–±—ä–µ–∫—Ç –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞. –°—Ç—Ä—É–∫—Ç—É—Ä–∞: {"
            "\"posts\": [string, string, string]} . "
            "–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ö–∞–∂–¥–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 400 –∏ –º–∞–∫—Å–∏–º—É–º 800 –∑–Ω–∞–∫–æ–≤ (–≤–∫–ª—é—á–∞—è –ø—Ä–æ–±–µ–ª—ã, —ç–º–æ–¥–∑–∏ –∏ –≤—Å–µ —Å–∏–º–≤–æ–ª—ã). "
            "–ù–µ –¥–µ–ª–∞–π –ø–æ—Å—Ç—ã –∫–æ—Ä–æ—á–µ 400 —Å–∏–º–≤–æ–ª–æ–≤! –ü–æ—Å—Ç—ã –∫–æ—Ä–æ—á–µ 400 —Å–∏–º–≤–æ–ª–æ–≤ –±—É–¥—É—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω—ã. "
            "–î–µ–ª–∞–π –ø–æ—Å—Ç—ã —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–º–∏, –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–º–∏. "
            "–ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏. "
            "–î–æ–±–∞–≤–ª—è–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –∏–∑ –∞–Ω–∞–ª–∏–∑–∞ —Å–∞–π—Ç–∞. "
            "–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ù–∏–∫–∞–∫–æ–≥–æ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.\njson"
        )
        # –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ù–ï –ø–µ—Ä–µ–¥–∞—ë–º cleaned_text - –≤—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —É–∂–µ –≤ intermediate_results!
        user_prompt = "json"
        # –ì–ò–ë–†–ò–î: –∏—Å–ø–æ–ª—å–∑—É–µ–º GPT-4o –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ JSON (—á–µ—Ä–µ–∑ use_alt=True)
        result = await run_in_threadpool(
            self.llm.chat_json,
            system_prompt=system_prompt,
            user_prompt=user_prompt,
            use_alt=True  # GPT-4o –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ JSON
        )
        return result

    async def analyze(
        self, 
        url: str, 
        style: str = "—É–±–µ–¥–∏—Ç–µ–ª—å–Ω–æ-–ø–æ–∑–∏—Ç–∏–≤–Ω–æ–º",
        occasion: str = "",
        use_cached: bool = False,
        cached_intermediate: Optional[List[Dict[str, Any]]] = None,
        saved_parsed_text: Optional[str] = None,
        saved_intermediate: Optional[List[Dict[str, Any]]] = None
    ) -> Dict[str, Any]:
        """
        –ê–Ω–∞–ª–∏–∑ —Å–∞–π—Ç–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞.
        –°–æ–≥–ª–∞—Å–Ω–æ –±–ª–æ–∫-—Å—Ö–µ–º–µ: –ø–∞—Ä—Å–∏–Ω–≥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑, –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        —Å –¥—Ä—É–≥–∏–º —Å—Ç–∏–ª–µ–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞.
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞
        if saved_parsed_text and saved_intermediate:
            print(f"[ANALYZE] Using saved parsing result for URL: {url}")
            cleaned_text = saved_parsed_text
            intermediate = saved_intermediate
            steps = [item.get("step", "") for item in intermediate if "step" in item]
            truncated = False
            truncation_message = None
        else:
            # –ü–∞—Ä—Å–∏–Ω–≥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            print(f"[ANALYZE] Performing fresh parsing for URL: {url}")
            html = await self.fetch_html(url)
            if not html:
                raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å HTML")

            cleaned_text, truncated, truncation_message = self.html_to_text(html)
            if not cleaned_text.strip():
                raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã")

            # –ü–æ–ª—É—á–∞–µ–º —à–∞–≥–∏ –∞–Ω–∞–ª–∏–∑–∞
            steps = await self.get_steps(cleaned_text)
            if not steps:
                raise ValueError("–ú–æ–¥–µ–ª—å –Ω–µ –≤–µ—Ä–Ω—É–ª–∞ —Å–ø–∏—Å–æ–∫ —à–∞–≥–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞")

            # üöÄ –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û–ï –í–´–ü–û–õ–ù–ï–ù–ò–ï –®–ê–ì–û–í –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –≤ 3-5 —Ä–∞–∑!
            print(f"[PARALLEL] Starting {len(steps)} steps in parallel...")
            tasks = [self.run_step_safe(step, cleaned_text) for step in steps]
            results = await asyncio.gather(*tasks)
            
            # –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–≤—Å–µ —É–∂–µ Dict, –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –≤ run_step_safe)
            intermediate = []
            for step, res in zip(steps, results):
                if "error" in res:
                    intermediate.append({"step": step, "error": res["error"]})
                    print(f"[PARALLEL] Step failed: {step[:50]}...")
                else:
                    intermediate.append({"step": step, "result": res})
                    print(f"[PARALLEL] Step completed: {step[:50]}...")
            
            print(f"[PARALLEL] All {len(steps)} steps completed!")

        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø–æ—Å—Ç–∞ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Å—Ç–∏–ª–µ (–≤—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è)
        final = await self.finalize(intermediate, cleaned_text, style, occasion)

        result = {
            "url": url,
            "style": style,
            "occasion": occasion,
            "steps": steps,
            "intermediate_results": intermediate,
            "final": final,
            "truncated": truncated,
            "truncation_message": truncation_message,
            "parsing_cached": saved_parsed_text is not None,  # –£–∫–∞–∑—ã–≤–∞–µ–º, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥
            "cleaned_text": cleaned_text  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º cleaned_text –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        }
        
        return result


